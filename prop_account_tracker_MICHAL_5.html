<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prop Firm Account Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #333;
            display: flex;
        }
        
        .sidebar {
            width: 250px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 30px 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
        }
        
        .sidebar-header p {
            margin: 8px 0 0 0;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.05em;
            color: #2c3e50;
        }
        
        .nav-item:hover {
            background: #f8f9fa;
            border-left-color: #3498db;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, #e3f2fd 0%, #f8f9fa 100%);
            border-left-color: #2196f3;
            font-weight: 600;
            color: #1976d2;
        }
        
        .nav-item .icon {
            font-size: 1.3em;
            width: 24px;
            text-align: center;
        }
        
        .main-content {
            margin-left: 250px;
            flex: 1;
            padding: 20px;
            min-height: 100vh;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .container {
            width: 100%;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .total-profit {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        /* Account Dashboard */
        .accounts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .account-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border-left: 6px solid #2ecc71;
            transition: transform 0.2s;
        }
        
        .account-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.3);
        }
        
        .account-card.warning {
            border-left-color: #f39c12;
        }
        
        .account-card.danger {
            border-left-color: #e74c3c;
        }
        
        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .account-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .account-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .account-status.healthy {
            background: #d4edda;
            color: #155724;
        }
        
        .account-status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .account-status.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .account-stats {
            margin-top: 15px;
        }
        
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .stat-row:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #7f8c8d;
            font-size: 0.95em;
        }
        
        .stat-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .stat-value.positive {
            color: #27ae60;
        }
        
        .stat-value.negative {
            color: #e74c3c;
        }
        
        .progress-bar-container {
            margin-top: 15px;
        }
        
        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .progress-fill.drawdown {
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 70%, #e74c3c 100%);
        }
        
        .progress-fill.profit {
            background: linear-gradient(90deg, #3498db 0%, #2ecc71 100%);
        }
        
        /* Main Content Grid */
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .card h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8em;
        }
        
        .card h3 {
            color: #34495e;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        /* Trade Entry Form */
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.05em;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .btn-danger:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }
        
        /* Discipline Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 2.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-box .label {
            font-size: 0.95em;
            color: #555;
            font-weight: 500;
        }
        
        /* Trade Log */
        .trade-log {
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .trade-entry {
            background: #f9f9f9;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            transition: all 0.2s;
        }
        
        .trade-entry:hover {
            background: #f0f0f0;
            transform: translateX(3px);
        }
        
        .trade-entry.offsystem {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }
        
        .trade-entry.system {
            border-left-color: #27ae60;
            background: #f0fff4;
        }
        
        .trade-entry.loss {
            background: #fff5f5;
            border-left-color: #e74c3c;
        }
        
        .trade-entry.win {
            background: #f0fff4;
            border-left-color: #27ae60;
        }
        
        .trade-entry.be {
            background: #fffbf0;
            border-left-color: #f39c12;
        }
        
        .trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .trade-type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .trade-type-badge.system {
            background: #27ae60;
            color: white;
        }
        
        .trade-type-badge.offsystem {
            background: #e74c3c;
            color: white;
        }
        
        .trade-pnl {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .trade-pnl.profit {
            color: #27ae60;
        }
        
        .trade-pnl.loss {
            color: #e74c3c;
        }
        
        .trade-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        
        .delete-btn:hover {
            background: #c0392b;
        }
        
        .risk-warning {
            background: #fff3cd;
            padding: 10px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.9em;
            color: #856404;
        }
        
        .risk-warning.danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .big-number {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
        }
        
        .big-number .value {
            font-size: 4em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .big-number .label {
            font-size: 1.2em;
            margin-top: 10px;
            opacity: 0.95;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-box {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }
        
        .comparison-box h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background: #ecf0f1;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .filter-btn.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
        }
        
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-header {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s;
            font-size: 16px;
        }
        
        .dropdown-header:hover {
            border-color: #3498db;
        }
        
        .dropdown-menu {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            margin-top: 5px;
        }
        
        .dropdown-menu.open {
            display: block;
        }
        
        .dropdown-item {
            padding: 12px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:hover {
            background: #f8f9fa;
        }
        
        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .dropdown-item label {
            cursor: pointer;
            flex: 1;
            font-size: 15px;
        }
        
        .input-group select[multiple] {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.3s;
            background: white;
        }
        
        .input-group select[multiple]:focus {
            outline: none;
            border-color: #3498db;
        }
        
        .input-group select[multiple] option {
            padding: 10px;
            border-radius: 4px;
            margin: 2px 0;
        }
        
        .input-group select[multiple] option:checked {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            font-weight: 600;
        }
        
        .trade-screenshot {
            margin-top: 10px;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.2s;
        }
        
        .trade-screenshot:hover {
            border-color: #3498db;
            transform: scale(1.02);
        }
        
        .trade-screenshot img {
            width: 100%;
            display: block;
        }
        
        .screenshot-thumbnail {
            max-height: 200px;
            object-fit: cover;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            cursor: pointer;
        }
        
        .modal-content {
            margin: auto;
            display: block;
            max-width: 90%;
            max-height: 90%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .collapsible-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .collapsible-header {
            padding: 12px 15px;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        .collapsible-header:hover {
            background: #e9ecef;
        }
        
        .collapsible-content {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .toggle-icon {
            transition: transform 0.3s;
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>üìà Trading Journal</h2>
            <p>Stay Disciplined. Stay Locked In.</p>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('overview')">
                <span class="icon">üìä</span>
                <span>Overview</span>
            </div>
            <div class="nav-item" onclick="switchTab('calendar')">
                <span class="icon">üìÖ</span>
                <span>Calendar</span>
            </div>
            <div class="nav-item" onclick="switchTab('performance')">
                <span class="icon">üìà</span>
                <span>Performance</span>
            </div>
            <div class="nav-item" onclick="switchTab('trade-history')">
                <span class="icon">üìã</span>
                <span>Trade History</span>
            </div>
            <div class="nav-item" onclick="switchTab('journal')">
                <span class="icon">üìñ</span>
                <span>Journal</span>
            </div>
            <div class="nav-item" onclick="switchTab('payouts')">
                <span class="icon">üí∞</span>
                <span>Payouts & Costs</span>
            </div>
            <div class="nav-item" onclick="switchTab('settings')">
                <span class="icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="container">
                <div class="header">
                    <h1>üìä Overview</h1>
                    <div class="total-profit" id="totalProfit">$0</div>
                    <div class="subtitle" id="totalProfitLabel">Combined Profit Across All Accounts</div>
                </div>
                
                <!-- Account Dashboard -->
                <div class="accounts-grid" id="accountsGrid">
                    <!-- Account cards will be generated here -->
                </div>
        
        <div class="content-grid">
            <!-- Trade Entry Form -->
            <div class="card">
                <h2>üìù Log Trade (Batch Entry)</h2>
                <p style="margin-bottom: 20px; color: #7f8c8d;">Enter once, applies to all selected accounts. Risk auto-scales: 50k base, 150k = 3x</p>
                
                <div class="input-group">
                    <label>Select Accounts</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button type="button" class="btn" onclick="applyToAll()" style="width: auto; padding: 10px 20px; margin: 0;">Apply to All Accounts</button>
                        <button type="button" class="btn" onclick="clearSelection()" style="width: auto; padding: 10px 20px; margin: 0; background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">Clear Selection</button>
                    </div>
                    <div class="custom-dropdown">
                        <div class="dropdown-header" onclick="toggleDropdown()">
                            <span id="dropdownText">Click to select accounts...</span>
                            <span style="float: right;">‚ñº</span>
                        </div>
                        <div class="dropdown-menu" id="dropdownMenu">
                            <!-- Account checkboxes will be generated here -->
                        </div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Trade Type</label>
                        <select id="tradeType">
                            <option value="system">‚úÖ System Trade (Following Rules)</option>
                            <option value="offsystem">‚ùå Off-System Trade (Broke Rules)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Result</label>
                        <select id="tradeResult" onchange="updateResultHint()">
                            <option value="win">üü¢ WIN</option>
                            <option value="loss">üî¥ LOSS</option>
                            <option value="be_win">üü° BE/WIN</option>
                            <option value="be_loss">üü° BE/LOSS</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Symbol</label>
                        <select id="tradeSymbol">
                            <option value="NQ">NQ</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Direction</label>
                        <select id="tradeDirection">
                            <option value="long">üìà LONG</option>
                            <option value="short">üìâ SHORT</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Model Used</label>
                        <select id="tradeModel">
                            <option value="model1">Model 1</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Setup Grade</label>
                        <select id="tradeGrade">
                            <option value="A" style="background: #d4edda; font-weight: bold;">A - Excellent Setup</option>
                            <option value="B" style="background: #d4edda;">B - Good Setup</option>
                            <option value="C" style="background: #fff3cd;">C - Average Setup</option>
                            <option value="troll" style="background: #f8d7da; font-weight: bold;">Troll - Bad Setup</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Risk Size</label>
                        <select id="tradeRiskSize">
                            <option value="1">Full Risk (1R)</option>
                            <option value="0.5">Half Risk (0.5R)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>P&L per 50k Account ($)</label>
                        <input type="number" id="tradePnl" step="0.01" placeholder="e.g., 250 or -150">
                        <div id="resultHint" style="margin-top: 5px; font-size: 0.85em; color: #7f8c8d;"></div>
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="tradeDate" value="">
                    </div>
                    <div class="input-group">
                        <label>Entry Time</label>
                        <input type="time" id="tradeEntryTime" value="">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Exit Time</label>
                        <input type="time" id="tradeExitTime" value="">
                    </div>
                    <div class="input-group">
                        <label>Screenshot (Optional)</label>
                        <input type="file" id="tradeScreenshot" accept="image/*" style="padding: 8px;">
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Note (Optional)</label>
                    <input type="text" id="tradeNote" placeholder="e.g., FOMO after missing setup">
                </div>
                
                <div id="riskAlert"></div>
                
                <!-- Collapsible Preview Section -->
                <div class="collapsible-section">
                    <div class="collapsible-header" onclick="toggleSection('previewSection')">
                        <span>üìä Trade Preview</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="previewSection" class="collapsible-content" style="display: none;">
                        <div id="batchPreview"></div>
                    </div>
                </div>
                
                <button class="btn" onclick="logBatchTrade()">Add Trade to Selected Accounts</button>
                
                <!-- Collapsible How It Works Section -->
                <div class="collapsible-section" style="margin-top: 20px;">
                    <div class="collapsible-header" onclick="toggleSection('howItWorksSection')">
                        <span>‚ÑπÔ∏è How it works</span>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div id="howItWorksSection" class="collapsible-content" style="display: none;">
                        <div class="alert alert-info" style="margin: 0;">
                            <strong>Batch Entry:</strong><br>
                            ‚Ä¢ Enter P&L for 50k base<br>
                            ‚Ä¢ Risk auto-calculated as 1:1 RR (Risk = |P&L|)<br>
                            ‚Ä¢ 150k accounts automatically get 3x the amounts<br>
                            ‚Ä¢ Select which accounts the trade applies to<br><br>
                            <strong>BE/WIN & BE/LOSS:</strong><br>
                            ‚Ä¢ For record-keeping only - tracks trades that went breakeven first<br>
                            ‚Ä¢ P&L still updates account balance<br>
                            ‚Ä¢ NOT counted in win rate statistics (excluded from win/loss calculation)
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Discipline Scorecard -->
            <div class="card">
                <h2>üìä Discipline Stats</h2>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value" id="totalTrades">0</div>
                        <div class="label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="systemTrades">0</div>
                        <div class="label">System Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="offsystemTrades">0</div>
                        <div class="label">Off-System Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="disciplineRate">0%</div>
                        <div class="label">Discipline Rate</div>
                    </div>
                </div>
                
                <h3>Performance Breakdown</h3>
                <div class="comparison-grid">
                    <div class="comparison-box">
                        <h4>System Trades</h4>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate</span>
                            <span class="stat-value" id="systemWinRate">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total P&L</span>
                            <span class="stat-value" id="systemPnl">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Win</span>
                            <span class="stat-value" id="systemAvgWin">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Loss</span>
                            <span class="stat-value" id="systemAvgLoss">-</span>
                        </div>
                    </div>
                    
                    <div class="comparison-box">
                        <h4>Off-System Trades</h4>
                        <div class="stat-row">
                            <span class="stat-label">Win Rate</span>
                            <span class="stat-value" id="offsystemWinRate">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total P&L</span>
                            <span class="stat-value" id="offsystemPnl">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Win</span>
                            <span class="stat-value" id="offsystemAvgWin">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Avg Loss</span>
                            <span class="stat-value" id="offsystemAvgLoss">-</span>
                        </div>
                    </div>
                </div>
                
                <div id="offsystemTaxDisplay" style="display:none;"></div>
                
                <h3>üìÖ This Week</h3>
                <div id="weeklyPerformance"></div>
            </div>
        </div>
        
        <!-- Trade History -->
        <div class="card">
            <h2>üìú Trade History</h2>
            
            <div class="filter-buttons" id="tradeHistoryFilters">
                <!-- Filter buttons will be generated dynamically -->
            </div>
            
            <button class="btn btn-danger" onclick="clearAllData()" style="width: auto; padding: 10px 20px; margin-bottom: 20px;">Clear All Data</button>
            
            <div class="trade-log" id="tradeLog">
                <div class="no-data">No trades logged yet</div>
            </div>
        </div>
            </div>
        </div>
        <!-- End Overview Tab -->
        
        <!-- Calendar Tab -->
        <div id="calendar" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>üìÖ Calendar</h1>
                    <div class="subtitle" id="cal-monthLabel">Monthly P&L Overview</div>
                </div>
                
                <!-- Account Filter -->
                <div style="margin-bottom: 20px;">
                    <label style="display:block; font-weight:600; color:#2c3e50; margin-bottom:8px;">Select Accounts:</label>
                    <div id="cal-account-filter" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
                </div>
                
                <div id="cal-exportTarget" style="background:#fff; border-radius:16px; padding:28px; box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                    <!-- Nav -->
                    <div style="display:flex; justify-content:center; align-items:center; gap:16px; margin-bottom:28px;">
                        <button onclick="calChangeMonth(-1)" style="background:#f8f9fa; border:none; border-radius:10px; width:40px; height:40px; cursor:pointer; font-size:1.2em; color:#2c3e50; display:flex; align-items:center; justify-content:center;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f8f9fa'">‚Äπ</button>
                        <div id="cal-title" style="font-size:1.5em; font-weight:800; color:#1a1a2e; letter-spacing:-0.5px; min-width:200px; text-align:center;"></div>
                        <button onclick="calChangeMonth(1)" style="background:#f8f9fa; border:none; border-radius:10px; width:40px; height:40px; cursor:pointer; font-size:1.2em; color:#2c3e50; display:flex; align-items:center; justify-content:center;" onmouseover="this.style.background='#eee'" onmouseout="this.style.background='#f8f9fa'">‚Ä∫</button>
                    </div>
                    
                    <!-- Day headers + Grid rendered by JS -->
                    <div id="cal-grid"></div>
                    
                    <!-- Monthly summary -->
                    <div id="cal-summary" style="margin-top:24px;"></div>
                </div>
                
                <!-- Export button -->
                <div style="display:flex; justify-content:flex-end; margin-top:16px;">
                    <button onclick="exportCalendarJpg()" class="btn" style="width:auto; padding:10px 24px; margin:0; display:flex; align-items:center; gap:8px;">
                        üì∏ Export as JPG
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Performance Tab -->
        <div id="performance" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>üìà Performance Analytics</h1>
                    <div class="subtitle">Every stat below counts one batch entry as one trade</div>
                </div>
                
                <!-- Filters -->
                <div style="display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:250px;">
                        <label style="display:block; font-weight:600; color:#2c3e50; margin-bottom:8px;">Time Range:</label>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            <button class="filter-btn" onclick="setPerfTimeRange('all')">Since Beginning</button>
                            <button class="filter-btn" onclick="setPerfTimeRange('today')">Today</button>
                            <button class="filter-btn active" onclick="setPerfTimeRange('week')">This Week</button>
                            <button class="filter-btn" onclick="setPerfTimeRange('month')">This Month</button>
                            <button class="filter-btn" onclick="setPerfTimeRange('quarter')">This Quarter</button>
                            <button class="filter-btn" onclick="setPerfTimeRange('year')">This Year</button>
                        </div>
                    </div>
                    <div style="flex:1; min-width:250px;">
                        <label style="display:block; font-weight:600; color:#2c3e50; margin-bottom:8px;">Trade Type:</label>
                        <div style="display:flex; flex-wrap:wrap; gap:6px;">
                            <button class="filter-btn active" id="perf-type-all" onclick="setPerfDiscipline('all')">All Trades</button>
                            <button class="filter-btn" id="perf-type-system" onclick="setPerfDiscipline('system')">‚úÖ System Only</button>
                            <button class="filter-btn" id="perf-type-offsystem" onclick="setPerfDiscipline('offsystem')">‚ùå Off-System Only</button>
                        </div>
                    </div>
                    <div style="flex:1; min-width:250px;">
                        <label style="display:block; font-weight:600; color:#2c3e50; margin-bottom:8px;">Accounts:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <button type="button" class="btn" onclick="perfSelectAll(event)" style="width: auto; padding: 8px 16px; margin: 0; font-size:0.9em;">All Accounts</button>
                            <button type="button" class="btn" onclick="perfClearSelection(event)" style="width: auto; padding: 8px 16px; margin: 0; background: #95a5a6; font-size:0.9em;">Clear</button>
                        </div>
                        <div class="custom-dropdown">
                            <div class="dropdown-header" onclick="togglePerfDropdown()">
                                <span id="perfDropdownText">Click to select accounts...</span>
                                <span style="float: right;">‚ñº</span>
                            </div>
                            <div class="dropdown-menu" id="perfDropdownMenu">
                                <!-- Account checkboxes will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Metrics Row -->
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-box">
                        <div class="value" id="perf-totalTrades">0</div>
                        <div class="label">Total Trades</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-winRate" style="color: #27ae60;">0%</div>
                        <div class="label">Win Rate</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-totalR">0R</div>
                        <div class="label">Total R</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-totalPnl">$0</div>
                        <div class="label">Total P&L</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-avgWin" style="color: #27ae60;">$0</div>
                        <div class="label">Avg Win</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-avgLoss" style="color: #e74c3c;">$0</div>
                        <div class="label">Avg Loss</div>
                    </div>
                    <div class="stat-box">
                        <div class="value" id="perf-rrRatio">0</div>
                        <div class="label">Actual R:R</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <!-- By Model -->
                    <div class="card">
                        <h2>üîß Performance by Model</h2>
                        <div id="perf-byModel"><div class="no-data">No trades yet</div></div>
                    </div>
                    
                    <!-- By Setup Grade -->
                    <div class="card">
                        <h2>üéØ Performance by Grade</h2>
                        <div id="perf-byGrade"><div class="no-data">No trades yet</div></div>
                    </div>
                    
                    <!-- By Direction -->
                    <div class="card">
                        <h2>üìä Long vs Short</h2>
                        <div id="perf-byDirection"><div class="no-data">No trades yet</div></div>
                    </div>
                    
                    <!-- System vs Off-System -->
                    <div class="card">
                        <h2>üß† Discipline Impact</h2>
                        <div id="perf-discipline"><div class="no-data">No trades yet</div></div>
                    </div>
                </div>
                
                <!-- BE Trades breakdown -->
                <div class="card" style="margin-top: 20px;">
                    <h2>üü° BE Trade Breakdown</h2>
                    <div id="perf-beTrades"><div class="no-data">No BE trades yet</div></div>
                </div>
            </div>
        </div>
        
        <!-- Trade History Tab -->
        <div id="trade-history" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>üìã Trade History Journal</h1>
                    <div class="subtitle">Review every trade with screenshots, notes, and details</div>
                </div>
                
                <!-- Filters -->
                <div class="card" style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <!-- Time Range Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Time Range</label>
                            <select id="history-time-filter" onchange="renderTradeHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week" selected>This Week</option>
                                <option value="month">This Month</option>
                                <option value="last-week">Last Week</option>
                                <option value="last-month">Last Month</option>
                            </select>
                        </div>
                        
                        <!-- Account Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Account</label>
                            <select id="history-account-filter" onchange="renderTradeHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="all">All Accounts</option>
                            </select>
                        </div>
                        
                        <!-- Trade Type Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Type</label>
                            <select id="history-type-filter" onchange="renderTradeHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="all">All Trades</option>
                                <option value="system">System Only</option>
                                <option value="offsystem">Off-System Only</option>
                            </select>
                        </div>
                        
                        <!-- Result Filter -->
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #2c3e50;">Result</label>
                            <select id="history-result-filter" onchange="renderTradeHistory()" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;">
                                <option value="all">All Results</option>
                                <option value="win">Wins Only</option>
                                <option value="loss">Losses Only</option>
                                <option value="be">BE Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Trade History Content -->
                <div id="trade-history-content">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- Journal Tab -->
        <div id="journal" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>üìñ Trading Journal</h1>
                    <p style="font-size: 1.1em; color: #7f8c8d; margin-top: 10px;">Use Trade History tab to review your trades with screenshots and notes</p>
                </div>
            </div>
        </div>
        
        <!-- Payouts & Costs Tab -->
        <div id="payouts" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>üí∞ Payouts & Costs</h1>
                    <div class="subtitle">Track withdrawals and account expenses</div>
                </div>
                
                <!-- Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;">
                    <div class="card" style="text-align: center; padding: 25px;">
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 8px;">Gross Payouts</div>
                        <div id="totalPayoutsGross" style="font-size: 2em; font-weight: bold; color: #27ae60;">$0</div>
                        <div style="font-size: 0.75em; color: #95a5a6; margin-top: 4px;">Withdrawn from accounts</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 25px;">
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 8px;">Net Payouts</div>
                        <div id="totalPayoutsNet" style="font-size: 2em; font-weight: bold; color: #27ae60;">$0</div>
                        <div style="font-size: 0.75em; color: #95a5a6; margin-top: 4px;">What you received</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 25px;">
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 8px;">Total Costs</div>
                        <div id="totalCosts" style="font-size: 2em; font-weight: bold; color: #e74c3c;">$0</div>
                        <div style="font-size: 0.75em; color: #95a5a6; margin-top: 4px;">Challenges & resets</div>
                    </div>
                    <div class="card" style="text-align: center; padding: 25px;">
                        <div style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 8px;">Net Profit</div>
                        <div id="netPayouts" style="font-size: 2em; font-weight: bold;">$0</div>
                        <div style="font-size: 0.75em; color: #95a5a6; margin-top: 4px;">Net payouts - costs</div>
                    </div>
                </div>
                
                <div class="content-grid">
                    <!-- Add Payout -->
                    <div class="card">
                        <h2>üí∏ Add Payout (Withdrawal)</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Record money withdrawn from your account. Gross amount deducted from balance, net amount is what you receive after split.</p>
                        
                        <div class="input-group">
                            <label>Account</label>
                            <select id="payout-account"></select>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Gross Amount ($) <span style="color:#7f8c8d; font-weight:400; font-size:0.9em;">‚Äî withdrawn from account</span></label>
                                <input type="number" id="payout-amount" step="0.01" placeholder="e.g. 5000" oninput="updatePayoutPreview()">
                            </div>
                            <div class="input-group">
                                <label>Profit Split</label>
                                <select id="payout-split" onchange="updatePayoutPreview()">
                                    <option value="100">100/0 (You keep 100%)</option>
                                    <option value="90" selected>90/10 (You keep 90%)</option>
                                    <option value="80">80/20 (You keep 80%)</option>
                                </select>
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="payout-date">
                            </div>
                            <div class="input-group">
                                <label>Net Amount <span style="color:#7f8c8d; font-weight:400; font-size:0.9em;">‚Äî what you receive</span></label>
                                <input type="number" id="payout-net" step="0.01" readonly style="background: #f8f9fa; color: #27ae60; font-weight: 700; font-size: 1.1em;">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Note <span style="color:#aaa;font-weight:400;">optional</span></label>
                            <input type="text" id="payout-note" placeholder="e.g. First payout, Profit split">
                        </div>
                        <button class="btn" onclick="addPayout()">Add Payout</button>
                    </div>
                    
                    <!-- Add Cost -->
                    <div class="card">
                        <h2>üí≥ Add Cost (Challenge/Account)</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Track challenge purchases, account fees, and resets.</p>
                        
                        <div class="input-group">
                            <label>Type</label>
                            <select id="cost-type">
                                <option value="challenge">Challenge</option>
                                <option value="s2f">Straight to Funded</option>
                                <option value="reset">Reset</option>
                            </select>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Account Size ($)</label>
                                <input type="number" id="cost-size" placeholder="e.g. 50000">
                            </div>
                            <div class="input-group">
                                <label>Price ($)</label>
                                <input type="number" id="cost-price" step="0.01" placeholder="e.g. 150">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Company</label>
                                <input type="text" id="cost-company" placeholder="e.g. Tradeify, Lucid">
                            </div>
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="cost-date">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Status</label>
                            <select id="cost-status">
                                <option value="pending">Pending</option>
                                <option value="passed">Passed ‚úÖ</option>
                                <option value="failed">Failed ‚ùå</option>
                            </select>
                        </div>
                        <button class="btn" onclick="addCost()">Add Cost</button>
                    </div>
                </div>
                
                <!-- History Tables -->
                <div class="content-grid">
                    <!-- Payout History -->
                    <div class="card">
                        <h2>üí∏ Payout History</h2>
                        <div id="payoutHistory" style="margin-top: 15px;">
                            <div class="no-data">No payouts yet</div>
                        </div>
                    </div>
                    
                    <!-- Cost History -->
                    <div class="card">
                        <h2>üí≥ Cost History</h2>
                        <div id="costHistory" style="margin-top: 15px;">
                            <div class="no-data">No costs yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Tab -->
        <div id="settings" class="tab-content">
            <div class="container">
                <div class="header">
                    <h1>‚öôÔ∏è Settings</h1>
                    <div class="subtitle">Manage your accounts</div>
                </div>
                
                <div class="content-grid">
                    <!-- Add Account -->
                    <div class="card">
                        <h2>‚ûï Add Account</h2>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Account Name</label>
                                <input type="text" id="new-name" placeholder="e.g. Tradeify 50k 3">
                            </div>
                            <div class="input-group">
                                <label>Account Size ($)</label>
                                <input type="number" id="new-size" placeholder="e.g. 50000">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Initial Balance ($)</label>
                                <input type="number" id="new-initialBalance" placeholder="e.g. 50000">
                            </div>
                            <div class="input-group">
                                <label>Max Drawdown ($)</label>
                                <input type="number" id="new-maxDrawdown" placeholder="e.g. 2000">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Profit Target ($) <span style="color:#aaa;font-weight:400;">optional</span></label>
                                <input type="number" id="new-profitTarget" placeholder="e.g. 9000 or leave blank">
                            </div>
                            <div class="input-group">
                                <label>Initial Drawdown ($)</label>
                                <input type="number" id="new-initialDrawdown" placeholder="e.g. 0" value="0">
                            </div>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>P&L Multiplier</label>
                                <select id="new-multiplier">
                                    <option value="1">1x (50k base)</option>
                                    <option value="2">2x (100k)</option>
                                    <option value="3">3x (150k)</option>
                                    <option value="4">4x (200k)</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn" onclick="addAccount()">Add Account</button>
                    </div>
                    
                    <!-- Balance Adjustment -->
                    <div class="card">
                        <h2>‚öñÔ∏è Balance Adjustment</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Use this to correct slippage differences between accounts. Adjustments affect balance only ‚Äî excluded from all stats, win rate, and performance.</p>
                        <div class="input-group">
                            <label>Select Account</label>
                            <select id="adj-account"></select>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Current Balance ($)</label>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="adj-amount" step="0.01" placeholder="e.g. 151324.75" style="flex: 1;">
                                    <button onclick="updateAdjustmentBalance(); return false;" style="padding: 10px 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;" title="Refresh to get current balance">üîÑ</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="adj-date">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Note <span style="color:#aaa;font-weight:400;">optional</span></label>
                            <input type="text" id="adj-note" placeholder="e.g. Slippage correction">
                        </div>
                        <button class="btn" onclick="addAdjustment()">Apply Adjustment</button>
                        
                        <!-- Adjustment history -->
                        <div style="margin-top:20px;">
                            <div onclick="toggleAdjHistory()" style="display:flex; justify-content:space-between; align-items:center; cursor:pointer; padding:10px 14px; background:#f8f9fa; border-radius:8px; border:1px solid #e0e0e0; user-select:none;">
                                <span style="font-weight:600; color:#2c3e50;">üìã Adjustment History</span>
                                <span id="adj-history-arrow" style="color:#7f8c8d; font-size:0.85em;">‚ñº Show</span>
                            </div>
                            <div id="adj-history" style="display:none; margin-top:8px;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Accounts List -->
                <div class="card" style="margin-top:20px;">
                    <h2>üìã Active Accounts</h2>
                    <div id="settings-accountList"></div>
                </div>
                
                <!-- Model Management -->
                <div class="card" style="margin-top:20px;">
                    <h2>üîß Trading Models</h2>
                    <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Define your setups. These appear in trade entry and performance analytics.</p>
                    
                    <!-- Existing models -->
                    <div id="settings-modelList" style="margin-bottom:25px;"></div>
                    
                    <!-- Add new model -->
                    <h3 style="margin-top:0;">Add New Model</h3>
                    <div class="input-row">
                        <div class="input-group">
                            <label>Model Name</label>
                            <input type="text" id="new-model-name" placeholder="e.g. Opening Range Breakout">
                        </div>
                        <div class="input-group">
                            <label>Description <span style="color:#aaa;font-weight:400;">optional</span></label>
                            <input type="text" id="new-model-desc" placeholder="e.g. 9:30-10:00 range breakout with volume">
                        </div>
                    </div>
                    <button class="btn" onclick="addModel()" style="margin-top:5px;">Add Model</button>
                </div>
                
                <!-- Symbol Management -->
                <div class="card" style="margin-top:20px;">
                    <h2>üìä Tradeable Symbols</h2>
                    <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Instruments available in the trade entry dropdown.</p>
                    
                    <!-- Symbol list -->
                    <div id="settings-symbolList" style="margin-bottom:20px;"></div>
                    
                    <!-- Add symbol -->
                    <div class="input-row" style="align-items:flex-end;">
                        <div class="input-group">
                            <label>Symbol</label>
                            <input type="text" id="new-symbol" placeholder="e.g. CL, GC, RTY" style="text-transform:uppercase;">
                        </div>
                        <div class="input-group" style="flex:0 0 auto;">
                            <button class="btn" onclick="addSymbol()" style="margin:0; width:auto; padding:10px 24px;">Add Symbol</button>
                        </div>
                    </div>
                    
                    <!-- Backup & Restore System -->
                    <div class="card" style="margin-top: 30px;">
                        <h2>üíæ Backup & Restore</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">
                            Download your data as JSON file or restore from a previous backup. Your data includes all trades, accounts, models, symbols, payouts, and costs.
                        </p>
                        
                        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;">
                            <button class="btn" onclick="exportToJSON()" style="width:auto; padding:10px 20px; background:#27ae60;">
                                üì• Export Backup (Download JSON)
                            </button>
                            <button class="btn" onclick="document.getElementById('import-file').click()" style="width:auto; padding:10px 20px; background:#3498db;">
                                üì§ Import Backup (Restore JSON)
                            </button>
                        </div>
                        
                        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importFromJSON(event)">
                        
                        <div style="padding:12px; background:#fff3cd; border:1px solid #ffc107; border-radius:6px; font-size:0.9em;">
                            <strong>üí° Tip:</strong> Export a backup before making big changes. Keep backups in a safe place!
                        </div>
                    </div>
                    
                    <!-- Google Drive Sync -->
                    <div class="card" style="margin-top: 30px;">
                        <h2>‚òÅÔ∏è Google Drive Sync (Optional)</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">
                            <span id="drive-status">Status: <strong>Checking...</strong></span><br>
                            Auto-sync to Google Drive. <strong style="color:#e74c3c;">Warning:</strong> Use manual backup instead if you experience issues.
                        </p>
                        <div style="display:flex; gap:10px; flex-wrap:wrap;">
                            <button class="btn" onclick="manualLoadFromDrive()" style="width:auto; padding:10px 20px; background:#4285f4;">
                                üì• Load from Drive
                            </button>
                            <button class="btn" onclick="manualSaveToDrive()" style="width:auto; padding:10px 20px; background:#34a853;">
                                üì§ Save to Drive
                            </button>
                            <button class="btn" onclick="disableDriveSync()" style="width:auto; padding:10px 20px; background:#95a5a6;">
                                üîå Disable Sync
                            </button>
                        </div>
                        <div id="drive-info" style="margin-top:15px; padding:12px; background:#f8f9fa; border-radius:6px; font-size:0.9em; color:#555; display:none;">
                            <div><strong>Last sync:</strong> <span id="drive-last-sync">Never</span></div>
                            <div><strong>File ID:</strong> <span id="drive-file-id" style="font-family:monospace; font-size:0.85em;">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
    
    <script>
        // ========================================
        // GOOGLE DRIVE SYNC CONFIGURATION
        // ========================================
        const GOOGLE_CLIENT_ID = '672858126629-g1lc0rrcadpcd9545t305nfof80rnnhv.apps.googleusercontent.com';
        const GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DRIVE_FILE_NAME = 'trading_journal_data.json';
        
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let driveFileId = null;
        let useDriveSync = localStorage.getItem('useDriveSync') === 'true';
        
        // Load Google API scripts
        function loadGoogleAPIs() {
            // Load GAPI
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.onload = gapiLoaded;
            gapiScript.async = true;
            gapiScript.defer = true;
            document.head.appendChild(gapiScript);
            
            // Load GIS
            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.onload = gisLoaded;
            gisScript.async = true;
            gisScript.defer = true;
            document.head.appendChild(gisScript);
        }
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_SCOPES,
                callback: '', // Will be set per request
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                if (useDriveSync) {
                    // User has Drive sync enabled - auto-load data from Drive
                    console.log('üîÑ Auto-loading from Drive...');
                    updateDriveStatus('Loading...', null);
                    showLoadingOverlay();
                    loadDataFromDrive();
                } else {
                    // Check if user wants to enable Drive sync
                    updateDriveStatus('Not enabled', null);
                    checkForLocalDataMigration();
                }
            } else {
                // Still waiting for APIs
                console.log('‚è≥ Waiting for Google APIs to load...');
            }
        }
        
        // Show loading overlay when Drive sync is enabled but data not loaded yet
        function showLoadingOverlay() {
            if (useDriveSync && gapiInited && gisInited) {
                const overlay = document.createElement('div');
                overlay.id = 'drive-loading-overlay';
                overlay.innerHTML = `
                    <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:10000; display:flex; align-items:center; justify-content:center;">
                        <div style="background:white; padding:40px; border-radius:12px; text-align:center; max-width:400px;">
                            <div style="font-size:48px; margin-bottom:20px;">‚òÅÔ∏è</div>
                            <h2 style="margin:0 0 10px 0; color:#2c3e50;">Loading from Drive</h2>
                            <p style="color:#7f8c8d; margin:0;">Syncing your trades...</p>
                            <div style="margin-top:20px;">
                                <div style="width:200px; height:4px; background:#ecf0f1; border-radius:2px; overflow:hidden; margin:0 auto;">
                                    <div style="width:100%; height:100%; background:#4285f4; animation:loading 1.5s ease-in-out infinite;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <style>
                        @keyframes loading {
                            0% { transform: translateX(-100%); }
                            50% { transform: translateX(100%); }
                            100% { transform: translateX(-100%); }
                        }
                    </style>
                `;
                document.body.appendChild(overlay);
                
                // Remove overlay after 10 seconds max (fallback)
                setTimeout(() => {
                    const el = document.getElementById('drive-loading-overlay');
                    if (el) el.remove();
                }, 10000);
            }
        }
        
        function hideLoadingOverlay() {
            const overlay = document.getElementById('drive-loading-overlay');
            if (overlay) overlay.remove();
        }
        
        // Check if user has local data to migrate
        function checkForLocalDataMigration() {
            const localTrades = localStorage.getItem('propTrades');
            if (localTrades) {
                const tradeCount = JSON.parse(localTrades).length;
                if (tradeCount > 0) {
                    setTimeout(() => {
                        if (confirm(`üìä Found ${tradeCount} trades in browser storage.\n\nüîÑ Enable Google Drive sync?\n\n‚úì Unlimited storage\n‚úì Never lose data\n‚úì Sync across devices\n\nClick OK to enable, or Cancel to continue with browser storage.`)) {
                            enableDriveSync();
                        }
                    }, 2000);
                }
            }
        }
        
        function enableDriveSync() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error:', resp);
                    alert('‚ùå Authentication failed. Please try again.');
                    return;
                }
                accessToken = gapi.client.getToken().access_token;
                useDriveSync = true;
                localStorage.setItem('useDriveSync', 'true');
                await migrateLocalDataToDrive();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function migrateLocalDataToDrive() {
            const localTrades = localStorage.getItem('propTrades');
            const localAccounts = localStorage.getItem('propAccounts');
            const localModels = localStorage.getItem('propModels');
            const localSymbols = localStorage.getItem('propSymbols');
            
            const data = {
                trades: localTrades ? JSON.parse(localTrades) : [],
                accounts: localAccounts ? JSON.parse(localAccounts) : {},
                models: localModels ? JSON.parse(localModels) : {},
                symbols: localSymbols ? JSON.parse(localSymbols) : ['NQ', 'ES', 'MNQ', 'MES'],
                lastUpdated: new Date().toISOString()
            };
            
            try {
                await saveDataToDrive(data);
                // Clear localStorage to free up space - data is now in Drive
                localStorage.removeItem('propTrades');
                localStorage.removeItem('propAccounts');
                localStorage.removeItem('propModels');
                localStorage.removeItem('propSymbols');
                alert('‚úÖ Success! Data migrated to Google Drive and browser storage cleared.\n\nRefresh to load from Drive.');
            } catch (err) {
                console.error('Migration error:', err);
                alert('‚ùå Error migrating data. Your trades are still safe in browser storage.');
                useDriveSync = false;
                localStorage.setItem('useDriveSync', 'false');
            }
        }
        
        async function findDriveFile() {
            try {
                console.log('üîç Searching for Drive file:', DRIVE_FILE_NAME);
                const response = await gapi.client.drive.files.list({
                    q: `name='${DRIVE_FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name, size, createdTime)',
                    orderBy: 'createdTime desc'
                });
                const files = response.result.files;
                console.log('üìÅ Files found:', files);
                
                if (files && files.length > 0) {
                    // If multiple files exist, pick the largest one (most data)
                    if (files.length > 1) {
                        console.warn(`‚ö†Ô∏è Found ${files.length} files with same name. Picking the largest.`);
                        files.sort((a, b) => (parseInt(b.size) || 0) - (parseInt(a.size) || 0));
                    }
                    console.log('‚úÖ Using file:', files[0].name, 'Size:', files[0].size, 'ID:', files[0].id);
                    return files[0].id;
                }
                console.log('‚ùå No files found');
                return null;
            } catch (error) {
                console.error('Error searching for Drive file:', error);
                return null;
            }
        }
        
        async function saveDataToDrive(data) {
            driveFileId = await findDriveFile();
            
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const close_delim = "\r\n--" + boundary + "--";
            
            const contentType = 'application/json';
            const metadata = {
                name: DRIVE_FILE_NAME,
                mimeType: contentType
            };
            
            const multipartRequestBody =
                delimiter +
                'Content-Type: application/json\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: ' + contentType + '\r\n\r\n' +
                JSON.stringify(data) +
                close_delim;
            
            const method = driveFileId ? 'PATCH' : 'POST';
            const path = driveFileId 
                ? `/upload/drive/v3/files/${driveFileId}`
                : '/upload/drive/v3/files';
            
            const response = await gapi.client.request({
                path: path,
                method: method,
                params: { uploadType: 'multipart' },
                headers: {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                },
                body: multipartRequestBody
            });
            
            if (!driveFileId && response.result.id) {
                driveFileId = response.result.id;
            }
            
            console.log('‚úÖ Data saved to Google Drive');
        }
        
        async function syncToDrive() {
            if (!useDriveSync || !accessToken) return;
            
            // Use data from MEMORY (includes screenshots), not localStorage
            const data = {
                trades: trades,  // Full trades with screenshots
                accounts: ACCOUNTS,
                models: MODELS,
                symbols: SYMBOLS,
                payouts: payouts,
                costs: costs,
                lastUpdated: new Date().toISOString()
            };
            
            try {
                await saveDataToDrive(data);
                console.log('‚úÖ Synced to Drive from memory (with screenshots)');
            } catch (err) {
                console.error('Auto-sync error:', err);
            }
        }
        
        async function loadDataFromDrive() {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error('Auth error loading from Drive:', resp);
                    return;
                }
                accessToken = gapi.client.getToken().access_token;
                
                try {
                    driveFileId = await findDriveFile();
                    if (driveFileId) {
                        const response = await gapi.client.drive.files.get({
                            fileId: driveFileId,
                            alt: 'media'
                        });
                        const data = response.result;
                        
                        // Load data into memory for this session (no localStorage when Drive sync is on)
                        if (data.trades) {
                            trades = data.trades;
                        }
                        if (data.accounts) {
                            ACCOUNTS = data.accounts;
                        }
                        if (data.models) {
                            MODELS = data.models;
                        }
                        if (data.symbols) {
                            SYMBOLS = data.symbols;
                        }
                        if (data.payouts) {
                            payouts = data.payouts;
                        }
                        if (data.costs) {
                            costs = data.costs;
                        }
                        
                        console.log('‚úÖ Data loaded from Google Drive');
                        updateDriveStatus('Loaded from Drive', data.lastUpdated);
                        hideLoadingOverlay();
                        
                        // Reinitialize UI with loaded data
                        generateAccountOptions();
                        generateModelOptions();
                        generateSymbolOptions();
                        renderPayoutsTab();
                        updateDisplay();
                    } else {
                        console.log('No Drive file found yet');
                        updateDriveStatus('No file in Drive', null);
                        hideLoadingOverlay();
                    }
                } catch (err) {
                    console.error('Error loading from Drive:', err);
                    hideLoadingOverlay();
                    alert('‚ö†Ô∏è Could not load data from Drive. Check console for details.');
                }
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function manualLoadFromDrive() {
            if (!gapiInited || !gisInited) {
                alert('‚è≥ Google APIs still loading... Please wait a moment and try again.');
                return;
            }
            loadDataFromDrive();
        }
        
        async function manualSaveToDrive() {
            if (!gapiInited || !gisInited) {
                alert('‚è≥ Google APIs still loading... Please wait a moment and try again.');
                return;
            }
            
            if (!accessToken) {
                alert('üîê Please load from Drive first to authenticate.');
                manualLoadFromDrive();
                return;
            }
            
            const data = {
                trades: JSON.parse(localStorage.getItem('propTrades') || '[]'),
                accounts: JSON.parse(localStorage.getItem('propAccounts') || '{}'),
                models: JSON.parse(localStorage.getItem('propModels') || '{}'),
                symbols: JSON.parse(localStorage.getItem('propSymbols') || '[]'),
                lastUpdated: new Date().toISOString()
            };
            
            try {
                await saveDataToDrive(data);
                updateDriveStatus('Synced', data.lastUpdated);
                alert('‚úÖ Data saved to Google Drive!');
            } catch (err) {
                console.error('Manual save error:', err);
                alert('‚ùå Error saving to Drive. Check console for details.');
            }
        }
        
        // Export/Import Backup Functions
        function exportToJSON() {
            const data = {
                trades: trades,
                accounts: ACCOUNTS,
                models: MODELS,
                symbols: SYMBOLS,
                payouts: payouts,
                costs: costs,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `trading_journal_backup_${timestamp}.json`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Backup exported!\n\nFile: ${filename}\n\nTrades: ${trades.length}\nAccounts: ${Object.keys(ACCOUNTS).length}\nPayouts: ${payouts.length}\nCosts: ${costs.length}`);
        }
        
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('‚ö†Ô∏è This will REPLACE all current data with the backup.\n\nMake sure you have a backup of your current data first!\n\nContinue?')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.trades && !data.accounts) {
                        throw new Error('Invalid backup file - missing required data');
                    }
                    
                    // Restore data
                    if (data.trades) trades = data.trades;
                    if (data.accounts) ACCOUNTS = data.accounts;
                    if (data.models) MODELS = data.models;
                    if (data.symbols) SYMBOLS = data.symbols;
                    if (data.payouts) payouts = data.payouts || [];
                    if (data.costs) costs = data.costs || [];
                    
                    // Save to localStorage
                    saveTradesToLocalStorage();
                    localStorage.setItem('propAccounts', JSON.stringify(ACCOUNTS));
                    localStorage.setItem('propModels', JSON.stringify(MODELS));
                    localStorage.setItem('propSymbols', JSON.stringify(SYMBOLS));
                    localStorage.setItem('propPayouts', JSON.stringify(payouts));
                    localStorage.setItem('propCosts', JSON.stringify(costs));
                    
                    // Refresh entire UI
                    generateAccountOptions();
                    generateModelOptions();
                    generateSymbolOptions();
                    renderSettingsPage();
                    renderPayoutsTab();
                    updateDisplay();
                    
                    const exportDate = data.exportDate ? new Date(data.exportDate).toLocaleString() : 'Unknown';
                    alert(`‚úÖ Backup restored successfully!\n\nBackup date: ${exportDate}\nTrades: ${trades.length}\nAccounts: ${Object.keys(ACCOUNTS).length}\nPayouts: ${payouts.length}\nCosts: ${costs.length}\n\nPage will reload to apply changes.`);
                    
                    // Reload page to ensure everything is fresh
                    setTimeout(() => location.reload(), 1000);
                    
                } catch (error) {
                    alert('‚ùå Error importing backup:\n\n' + error.message + '\n\nPlease make sure you selected a valid backup file.');
                    console.error('Import error:', error);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('‚ùå Error reading file. Please try again.');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        function disableDriveSync() {
            if (confirm('Disable Google Drive sync?\n\nYour data will stay in Drive, but auto-sync will stop. You can re-enable it anytime.')) {
                useDriveSync = false;
                localStorage.setItem('useDriveSync', 'false');
                updateDriveStatus('Disabled', null);
                alert('üîå Drive sync disabled. Data remains in Drive.');
            }
        }
        
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        // Validate data structure
                        if (!data.trades || !Array.isArray(data.trades)) {
                            alert('‚ùå Invalid JSON file. Must contain a "trades" array.');
                            return;
                        }
                        
                        // Load into memory only (not localStorage when Drive sync is on)
                        if (data.trades) {
                            trades = data.trades;
                        }
                        if (data.accounts) {
                            ACCOUNTS = data.accounts;
                        }
                        if (data.models) {
                            MODELS = data.models;
                        }
                        if (data.symbols) {
                            SYMBOLS = data.symbols;
                        }
                        
                        // Save to Drive if sync enabled and APIs ready
                        if (useDriveSync && gapiInited && gisInited && accessToken) {
                            data.lastUpdated = new Date().toISOString();
                            await saveDataToDrive(data);
                            updateDriveStatus('Imported & Synced', data.lastUpdated);
                            alert('‚úÖ JSON imported and saved to Drive!\n\nRefreshing page...');
                        } else {
                            alert('‚úÖ JSON imported to browser!\n\nClick "Save to Drive" to sync it, or refresh to see your trades.');
                        }
                        
                        // Refresh UI
                        generateAccountOptions();
                        generateModelOptions();
                        generateSymbolOptions();
                        updateDisplay();
                        
                    } catch (err) {
                        console.error('Import error:', err);
                        alert('‚ùå Error importing JSON: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function updateDriveStatus(status, lastSync) {
            const statusEl = document.getElementById('drive-status');
            const infoEl = document.getElementById('drive-info');
            const lastSyncEl = document.getElementById('drive-last-sync');
            const fileIdEl = document.getElementById('drive-file-id');
            
            // Overview widget elements
            const overviewStatusEl = document.getElementById('drive-status-overview');
            const overviewLastSyncEl = document.getElementById('drive-last-sync-overview');
            
            let color = '#7f8c8d';
            let emoji = '‚è≥';
            if (status.includes('Synced') || status.includes('Loaded')) {
                color = '#27ae60';
                emoji = '‚úÖ';
            }
            if (status.includes('Error') || status.includes('Disabled')) {
                color = '#e74c3c';
                emoji = '‚ùå';
            }
            if (status.includes('Not enabled')) {
                color = '#f39c12';
                emoji = '‚ö†Ô∏è';
            }
            
            // Update Settings tab status
            if (statusEl) {
                statusEl.innerHTML = `Status: <strong style="color:${color}">${status}</strong>`;
            }
            
            // Update Overview widget
            if (overviewStatusEl) {
                overviewStatusEl.innerHTML = `${emoji} <strong style="color:${color}">${status}</strong>`;
            }
            
            if (overviewLastSyncEl && lastSync) {
                const date = new Date(lastSync);
                overviewLastSyncEl.textContent = `Last: ${date.toLocaleTimeString()}`;
            } else if (overviewLastSyncEl) {
                overviewLastSyncEl.textContent = '';
            }
            
            if (infoEl && lastSync) {
                infoEl.style.display = 'block';
                if (lastSyncEl) lastSyncEl.textContent = new Date(lastSync).toLocaleString();
                if (fileIdEl && driveFileId) fileIdEl.textContent = driveFileId;
            }
        }
        
        // Override localStorage setItem to auto-sync
        const originalSetItem = localStorage.setItem;
        localStorage.setItem = function(key, value) {
            originalSetItem.apply(this, arguments);
            if (key.startsWith('prop') && useDriveSync) {
                // Debounce sync - wait 2 seconds after last change
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
        };
        
        // Helper function to save trades - uses Drive if enabled, localStorage if not
        function saveTrades() {
            if (useDriveSync) {
                // Just trigger Drive sync, don't fill localStorage
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            } else {
                // Save to localStorage
                localStorage.setItem('propTrades', JSON.stringify(trades));
            }
        }
        
        function saveAccounts() {
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            } else {
                localStorage.setItem('propAccounts', JSON.stringify(ACCOUNTS));
            }
        }
        
        function saveModels() {
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            } else {
                localStorage.setItem('propModels', JSON.stringify(MODELS));
            }
        }
        
        function saveSymbols() {
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            } else {
                localStorage.setItem('propSymbols', JSON.stringify(SYMBOLS));
            }
        }
        
        // Load Google APIs on page load - but don't block the app
        setTimeout(() => {
            if (typeof gapi === 'undefined') {
                loadGoogleAPIs();
            }
        }, 1000);
        
        // ========================================
        // END GOOGLE DRIVE SYNC
        // ========================================
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            if (tabName === 'settings') renderSettingsPage();
            if (tabName === 'payouts') renderPayoutsTab();
            if (tabName === 'trade-history') renderTradeHistory();
            if (tabName === 'calendar') {
                generateCalendarAccountFilter();
                renderCalendar();
            }
            if (tabName === 'performance') {
                generatePerfAccountFilter();
                // Select all by default on first load
                if (perfSelectedAccounts.length === 0) {
                    // Set state to all account IDs
                    perfSelectedAccounts = Object.keys(ACCOUNTS);
                    // Update checkboxes to match state
                    setTimeout(() => {
                        document.querySelectorAll('#perfDropdownMenu input[type="checkbox"]').forEach(cb => {
                            cb.checked = true;
                        });
                        document.getElementById('perfDropdownText').textContent = 'All Accounts';
                        updatePerformanceTab();
                    }, 0);
                } else {
                    updatePerformanceTab();
                }
            }
        }
        
        // Account configurations - load from localStorage or use defaults
        const DEFAULT_ACCOUNTS = {
            lucid1: { name: 'Lucid 150k S2F 1', size: 150000, maxDrawdown: 6000, profitTarget: 9000, initialBalance: 151330, initialDrawdown: 782, minRisk: 660, maxRisk: 810, multiplier: 3 },
            lucid2: { name: 'Lucid 150k S2F 2', size: 150000, maxDrawdown: 6000, profitTarget: 9000, initialBalance: 151310, initialDrawdown: 796, minRisk: 660, maxRisk: 810, multiplier: 3 },
            lucid3: { name: 'Lucid 150k S2F 3', size: 150000, maxDrawdown: 6000, profitTarget: 9000, initialBalance: 151286, initialDrawdown: 782, minRisk: 660, maxRisk: 810, multiplier: 3 },
            lucid4: { name: 'Lucid 150k S2F 4', size: 150000, maxDrawdown: 6000, profitTarget: 9000, initialBalance: 151286, initialDrawdown: 782, minRisk: 660, maxRisk: 810, multiplier: 3 },
            lucid5: { name: 'Lucid 150k S2F 5', size: 150000, maxDrawdown: 6000, profitTarget: 9000, initialBalance: 151272, initialDrawdown: 796, minRisk: 660, maxRisk: 810, multiplier: 3 },
            tradeify1: { name: 'Tradeify Live 50k 1', size: 50000, maxDrawdown: 2000, profitTarget: null, initialBalance: 50000, initialDrawdown: 0, minRisk: 220, maxRisk: 270, multiplier: 1 },
            tradeify2: { name: 'Tradeify Live 50k 2', size: 50000, maxDrawdown: 2000, profitTarget: null, initialBalance: 50000, initialDrawdown: 0, minRisk: 220, maxRisk: 270, multiplier: 1 }
        };
        let ACCOUNTS = JSON.parse(localStorage.getItem('propAccounts')) || DEFAULT_ACCOUNTS;
        
        function saveAccounts() {
            localStorage.setItem('propAccounts', JSON.stringify(ACCOUNTS));
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
        }
        
        // Models - load from localStorage or use defaults
        const DEFAULT_MODELS = {
            model1: { name: 'Model 1', description: '' },
            model2: { name: 'Model 2', description: '' },
            model3: { name: 'Model 3', description: '' },
            model4: { name: 'Model 4', description: '' }
        };
        let MODELS = JSON.parse(localStorage.getItem('propModels')) || DEFAULT_MODELS;
        
        function saveModels() {
            localStorage.setItem('propModels', JSON.stringify(MODELS));
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
        }
        
        // Symbols - load from localStorage or use defaults
        const DEFAULT_SYMBOLS = ['NQ', 'ES', 'MNQ', 'MES'];
        let SYMBOLS = JSON.parse(localStorage.getItem('propSymbols')) || DEFAULT_SYMBOLS;
        
        function saveSymbols() {
            localStorage.setItem('propSymbols', JSON.stringify(SYMBOLS));
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
        }
        
        let trades = JSON.parse(localStorage.getItem('propTrades')) || [];
        
        // Migrate old "bullshit" trades to "offsystem"
        trades = trades.map(t => {
            if (t.type === 'bullshit') {
                return { ...t, type: 'offsystem' };
            }
            return t;
        });
        
        let currentFilter = 'system';
        
        // Set current date/time
        const now = new Date();
        document.getElementById('tradeDate').valueAsDate = now;
        document.getElementById('tradeEntryTime').value = now.toTimeString().slice(0,5);
        document.getElementById('tradeExitTime').value = now.toTimeString().slice(0,5);
        
        function openModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imageSrc;
        }
        
        function closeModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        function calculateDuration(entryTime, exitTime) {
            if (!entryTime || !exitTime) return '';
            
            const [entryHour, entryMin] = entryTime.split(':').map(Number);
            const [exitHour, exitMin] = exitTime.split(':').map(Number);
            
            let totalMinutes = (exitHour * 60 + exitMin) - (entryHour * 60 + entryMin);
            
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60; // Handle overnight trades
            }
            
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        // Generate account checkboxes in dropdown
        function toggleAdjHistory() {
            const panel = document.getElementById('adj-history');
            const arrow = document.getElementById('adj-history-arrow');
            const adjustments = trades.filter(t => t.type === 'adjustment');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                arrow.textContent = `‚ñ≤ Hide (${adjustments.length})`;
            } else {
                panel.style.display = 'none';
                arrow.textContent = `‚ñº Show (${adjustments.length})`;
            }
        }
        
        // ‚îÄ‚îÄ CALENDAR FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        let calYear = new Date().getFullYear();
        let calMonth = new Date().getMonth(); // 0-indexed
        let calSelectedAccounts = []; // empty = all
        
        function generateCalendarAccountFilter() {
            const container = document.getElementById('cal-account-filter');
            if (!container) return;
            
            container.innerHTML = `
                <button class="filter-btn ${calSelectedAccounts.length === 0 ? 'active' : ''}" onclick="toggleCalAccount(null)">All Accounts</button>
                ${Object.keys(ACCOUNTS).map(id => `
                    <button class="filter-btn ${calSelectedAccounts.includes(id) ? 'active' : ''}" onclick="toggleCalAccount('${id}')">${ACCOUNTS[id].name}</button>
                `).join('')}
            `;
        }
        
        function toggleCalAccount(accountId) {
            if (accountId === null) {
                calSelectedAccounts = [];
            } else {
                const idx = calSelectedAccounts.indexOf(accountId);
                if (idx >= 0) {
                    calSelectedAccounts.splice(idx, 1);
                } else {
                    calSelectedAccounts.push(accountId);
                }
            }
            generateCalendarAccountFilter();
            renderCalendar();
        }
        
        function calChangeMonth(dir) {
            calMonth += dir;
            if (calMonth > 11) { calMonth = 0; calYear++; }
            if (calMonth < 0)  { calMonth = 11; calYear--; }
            renderCalendar();
        }
        
        function getDayPnl(dateStr) {
            const accountFilter = calSelectedAccounts.length > 0 
                ? (t => calSelectedAccounts.includes(t.account))
                : (() => true);
            
            // Calculate P&L from system trades + adjustments only
            const systemPnl = trades
                .filter(t => t.type === 'system' && t.date === dateStr && accountFilter(t))
                .reduce((sum, t) => sum + t.pnl, 0);
            
            const adjustmentPnl = trades
                .filter(t => t.type === 'adjustment' && t.date === dateStr && accountFilter(t))
                .reduce((sum, t) => sum + t.pnl, 0);
            
            return systemPnl + adjustmentPnl;
        }
        
        function getDayTrades(dateStr) {
            // unique batches for trade count display
            const accountFilter = calSelectedAccounts.length > 0 
                ? (t => calSelectedAccounts.includes(t.account))
                : (() => true);
            const dayTrades = trades.filter(t => t.type !== 'adjustment' && t.date === dateStr && accountFilter(t));
            const seen = new Set();
            dayTrades.forEach(t => seen.add(String(t.batchId || Math.floor(t.id/10)*10)));
            return seen.size;
        }
        
        function getDayR(dateStr) {
            // R from unique batches only, excluding BE trades
            // R is per batch, not per account - all accounts in a batch have same R
            // Only count SYSTEM trades for R calculation
            const unique = getUniqueTrades();
            const dayBatches = unique.filter(t => t.date === dateStr && t.type === 'system' && (t.result === 'win' || t.result === 'loss'));
            
            if (calSelectedAccounts.length === 0) {
                // No filter - sum R from all batches
                return dayBatches.reduce((sum, t) => sum + (t.rValue || 0), 0);
            } else {
                // Filtered - only include batches that have at least one selected account
                // But R is still per batch, not summed across accounts
                let totalR = 0;
                dayBatches.forEach(uniqueTrade => {
                    const batchKey = String(uniqueTrade.batchId || Math.floor(uniqueTrade.id / 10) * 10);
                    const batchTrades = trades.filter(t => 
                        String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey
                    );
                    // Check if this batch includes any selected accounts
                    const hasSelectedAccount = batchTrades.some(t => calSelectedAccounts.includes(t.account));
                    if (hasSelectedAccount) {
                        // Add R once per batch (take from first trade, they all have same R)
                        const firstTrade = batchTrades.find(t => t.rValue !== undefined);
                        totalR += (firstTrade ? firstTrade.rValue : 0);
                    }
                });
                return totalR;
            }
        }
        
        function renderCalendar() {
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const title = `${monthNames[calMonth]} ${calYear}`;
            document.getElementById('cal-title').textContent = title;
            document.getElementById('cal-monthLabel').textContent = title;
            
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            
            const firstDay = new Date(calYear, calMonth, 1);
            let startOffset = firstDay.getDay() - 1;
            if (startOffset < 0) startOffset = 6;
            
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            
            const cells = [];
            for (let i = 0; i < startOffset; i++) cells.push(null);
            for (let d = 1; d <= daysInMonth; d++) cells.push(d);
            while (cells.length % 7 !== 0) cells.push(null);
            
            let monthPnl = 0, monthR = 0, winDays = 0, lossDays = 0, beDays = 0, tradeDays = 0;
            
            // Pre-calculate all day data
            const dayData = {};
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const pnl = getDayPnl(dateStr);
                const r = getDayR(dateStr);
                const count = getDayTrades(dateStr);
                dayData[d] = { dateStr, pnl, r, count };
                if (count > 0) {
                    tradeDays++;
                    monthPnl += pnl;
                    monthR += r;
                    // Use R to determine win/loss/BE (not P&L)
                    if (Math.abs(r) < 0.01) beDays++;  // R is ~0 = BE
                    else if (r > 0) winDays++;          // R > 0 = win
                    else lossDays++;                    // R < 0 = loss
                }
            }
            
            // Day headers ‚Äî Sat/Sun greyed
            const dayHeaders = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map((d, i) =>
                `<div style="text-align:center; font-size:0.78em; font-weight:700; color:${i >= 5 ? '#d0d5dd' : '#b0b8c4'}; padding:6px 0; letter-spacing:0.5px;">${d}</div>`
            ).join('');
            
            // Day cells
            const dayCells = cells.map((day, cellIndex) => {
                // cellIndex % 7: 0=Mon..4=Fri, 5=Sat, 6=Sun
                const isWeekend = (cellIndex % 7) >= 5;
                if (day === null) return `<div></div>`;
                
                const { dateStr, pnl, r, count } = dayData[day];
                const isToday = dateStr === todayStr;
                const isFuture = dateStr > todayStr;
                const hasTraded = count > 0;
                
                let bg, borderColor, pnlColor, textColor = '#2c3e50';
                
                if (isFuture || !hasTraded) {
                    bg = isWeekend ? '#f0f0f0' : '#f9fafb';
                    borderColor = isToday ? '#3498db' : 'transparent';
                    pnlColor = '#d0d5dd';
                } else if (Math.abs(r) < 0.01) {
                    // R is ~0 = BE day (yellow)
                    bg = 'linear-gradient(145deg, #fffcf0, #fef3d0)';
                    borderColor = '#f39c12';
                    pnlColor = '#d68910';
                } else if (r > 0) {
                    // R > 0 = win day (green)
                    bg = 'linear-gradient(145deg, #f0fff6, #dcf5e8)';
                    borderColor = '#27ae60';
                    pnlColor = '#1e8449';
                } else {
                    // R < 0 = loss day (red)
                    bg = 'linear-gradient(145deg, #fff5f5, #fde0e0)';
                    borderColor = '#e74c3c';
                    pnlColor = '#c0392b';
                }
                
                const shadow = hasTraded
                    ? `0 2px 8px ${Math.abs(r) < 0.01 ? 'rgba(243,156,18,0.12)' : r > 0 ? 'rgba(39,174,96,0.15)' : 'rgba(231,76,60,0.15)'}`
                    : 'none';
                const todayStyle = isToday ? `box-shadow: 0 0 0 2.5px #3498db, ${shadow};` : `box-shadow:${shadow};`;
                
                const formattedPnl = Math.abs(pnl) >= 1000
                    ? `${pnl >= 0 ? '+' : '-'}$${(Math.abs(pnl)/1000).toFixed(1)}k`
                    : `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(0)}`;
                
                return `
                    <div style="min-height:88px; background:${bg}; border:1.5px solid ${borderColor}; border-radius:12px; padding:10px; display:flex; flex-direction:column; justify-content:space-between; ${todayStyle} transition:transform 0.1s;" 
                         onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:0.82em; font-weight:700; color:${isToday ? '#3498db' : isWeekend ? '#c8cdd5' : '#9aa5b4'};">${day}</span>
                            ${hasTraded ? `<span style="font-size:0.68em; font-weight:600; background:rgba(0,0,0,0.06); color:#888; border-radius:20px; padding:1px 6px;">${count}</span>` : ''}
                        </div>
                        <div style="text-align:center; padding:4px 0;">
                            ${hasTraded
                                ? `<div style="font-size:1.05em; font-weight:800; color:${pnlColor}; letter-spacing:-0.3px;">${formattedPnl}</div>
                                   <div style="font-size:0.72em; font-weight:700; color:${pnlColor}; opacity:0.75; margin-top:1px;">${r >= 0 ? '+' : ''}${r.toFixed(2)}R</div>`
                                : `<span style="font-size:0.8em; color:#dde1e7;">${isFuture ? '' : '‚Äî'}</span>`
                            }
                        </div>
                    </div>`;
            }).join('');
            
            document.getElementById('cal-grid').innerHTML = `
                <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:4px;">${dayHeaders}</div>
                <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;">${dayCells}</div>
            `;
            
            // Summary bar
            const winRate = (winDays + lossDays) > 0 ? Math.round(winDays / (winDays + lossDays) * 100) : 0;
            const wrColor = winRate >= 60 ? '#27ae60' : winRate >= 45 ? '#f39c12' : '#e74c3c';
            const monthRColor = monthR > 0 ? '#27ae60' : monthR < 0 ? '#e74c3c' : '#f39c12';
            const monthPnlFmt = Math.abs(monthPnl) >= 1000
                ? `${monthPnl >= 0 ? '+' : '-'}$${(Math.abs(monthPnl)/1000).toFixed(1)}k`
                : `${monthPnl >= 0 ? '+' : ''}$${monthPnl.toFixed(0)}`;
            
            const summaryItems = [
                { val: monthPnlFmt, label: 'Month P&L', color: monthPnl >= 0 ? '#27ae60' : '#e74c3c' },
                { val: `${monthR >= 0 ? '+' : ''}${monthR.toFixed(2)}R`, label: 'Total R', color: monthRColor },
                { val: winDays, label: 'Green Days', color: '#27ae60' },
                { val: lossDays, label: 'Red Days', color: '#e74c3c' },
                { val: beDays, label: 'BE Days', color: '#f39c12' },
                { val: winRate + '%', label: 'Day Win Rate', color: wrColor },
            ];
            
            document.getElementById('cal-summary').innerHTML = `
                <div style="background:#f8f9fb; border-radius:14px; padding:18px 10px; display:grid; grid-template-columns:repeat(6,1fr); gap:8px;">
                    ${summaryItems.map(s => `
                        <div style="text-align:center;">
                            <div style="font-size:1.15em; font-weight:800; color:${s.color}; letter-spacing:-0.5px;">${s.val}</div>
                            <div style="font-size:0.7em; color:#aab; margin-top:3px; font-weight:600; text-transform:uppercase; letter-spacing:0.4px;">${s.label}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function exportCalendarJpg() {
            const target = document.getElementById('cal-exportTarget');
            const btn = target.querySelector ? null : null;
            
            html2canvas(target, {
                backgroundColor: '#ffffff',
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                const filename = `trading-calendar-${monthNames[calMonth]}-${calYear}.jpg`;
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            });
        }
        
        // ‚îÄ‚îÄ END CALENDAR FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // ‚îÄ‚îÄ SYMBOL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function addSymbol() {
            const val = document.getElementById('new-symbol').value.trim().toUpperCase();
            if (!val) { alert('Please enter a symbol'); return; }
            if (SYMBOLS.includes(val)) { alert(`${val} already exists`); return; }
            SYMBOLS.push(val);
            saveSymbols();
            document.getElementById('new-symbol').value = '';
            generateSymbolOptions();
            renderSettingsPage();
        }
        
        function deleteSymbol(sym) {
            if (!confirm(`Remove ${sym}?`)) return;
            SYMBOLS = SYMBOLS.filter(s => s !== sym);
            saveSymbols();
            generateSymbolOptions();
            renderSettingsPage();
        }
        
        // ‚îÄ‚îÄ END SYMBOL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // ‚îÄ‚îÄ MODEL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function addModel() {
            const name = document.getElementById('new-model-name').value.trim();
            const description = document.getElementById('new-model-desc').value.trim();
            
            if (!name) { alert('Please enter a model name'); return; }
            
            const id = 'model_' + Date.now();
            MODELS[id] = { name, description };
            saveModels();
            
            document.getElementById('new-model-name').value = '';
            document.getElementById('new-model-desc').value = '';
            
            generateModelOptions();
            renderSettingsPage();
        }
        
        function deleteModel(modelId) {
            const model = MODELS[modelId];
            if (!model) return;
            const usedCount = trades.filter(t => t.model === modelId).length;
            const warning = usedCount > 0 ? `\n\nNote: ${usedCount} trade(s) use this model ‚Äî data is preserved but will show as unknown.` : '';
            if (!confirm(`Delete model "${model.name}"?${warning}`)) return;
            delete MODELS[modelId];
            saveModels();
            generateModelOptions();
            renderSettingsPage();
        }
        
        function startEditModel(modelId) {
            const model = MODELS[modelId];
            const row = document.getElementById(`model-row-${modelId}`);
            row.innerHTML = `
                <div style="flex:1; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                    <input type="text" id="edit-model-name-${modelId}" value="${model.name}" 
                        style="padding:8px; border:2px solid #3498db; border-radius:6px; font-size:0.95em; flex:1; min-width:120px;">
                    <input type="text" id="edit-model-desc-${modelId}" value="${model.description || ''}" 
                        placeholder="Description..."
                        style="padding:8px; border:2px solid #e0e0e0; border-radius:6px; font-size:0.95em; flex:2; min-width:180px;">
                </div>
                <div style="display:flex; gap:8px; margin-top:5px;">
                    <button class="btn" onclick="saveEditModel('${modelId}')" style="width:auto; padding:8px 16px; margin:0; font-size:0.9em;">Save</button>
                    <button class="btn" onclick="renderSettingsPage()" style="width:auto; padding:8px 16px; margin:0; font-size:0.9em; background:linear-gradient(135deg,#95a5a6,#7f8c8d);">Cancel</button>
                </div>
            `;
        }
        
        function saveEditModel(modelId) {
            const name = document.getElementById(`edit-model-name-${modelId}`).value.trim();
            const description = document.getElementById(`edit-model-desc-${modelId}`).value.trim();
            if (!name) { alert('Model name cannot be empty'); return; }
            MODELS[modelId] = { name, description };
            saveModels();
            generateModelOptions();
            renderSettingsPage();
        }
        
        // ‚îÄ‚îÄ END MODEL FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        // ‚îÄ‚îÄ SETTINGS FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function generateAccountId() {
            return 'acc_' + Date.now();
        }
        
        function addAccount() {
            const name = document.getElementById('new-name').value.trim();
            const size = parseFloat(document.getElementById('new-size').value);
            const initialBalance = parseFloat(document.getElementById('new-initialBalance').value);
            const maxDrawdown = parseFloat(document.getElementById('new-maxDrawdown').value);
            const profitTargetVal = document.getElementById('new-profitTarget').value;
            const profitTarget = profitTargetVal ? parseFloat(profitTargetVal) : null;
            const initialDrawdown = parseFloat(document.getElementById('new-initialDrawdown').value) || 0;
            const multiplier = parseFloat(document.getElementById('new-multiplier').value);
            
            if (!name || isNaN(size) || isNaN(initialBalance) || isNaN(maxDrawdown)) {
                alert('Please fill in all required fields');
                return;
            }
            
            const id = generateAccountId();
            ACCOUNTS[id] = {
                name, size, initialBalance, maxDrawdown, profitTarget,
                initialDrawdown, multiplier,
                minRisk: Math.round(size * 0.004),
                maxRisk: Math.round(size * 0.005)
            };
            saveAccounts();
            
            // Clear form
            ['new-name','new-size','new-initialBalance','new-maxDrawdown','new-profitTarget'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('new-initialDrawdown').value = '0';
            document.getElementById('new-multiplier').value = '1';
            
            generateAccountOptions();
            applyToAll();
            renderSettingsPage();
            updateDisplay();
            alert(`‚úÖ Account "${name}" added!`);
        }
        
        function deleteAccount(accountId) {
            const account = ACCOUNTS[accountId];
            if (!account) return;
            if (!confirm(`Delete "${account.name}"?\n\nThis will permanently remove the account AND all its trade history. This cannot be undone.`)) return;
            if (!confirm(`Are you sure? All trades for "${account.name}" will be deleted forever.`)) return;
            
            // Remove all trades for this account
            trades = trades.filter(t => t.account !== accountId);
            saveTradesToLocalStorage();
            
            // Remove account
            delete ACCOUNTS[accountId];
            saveAccounts();
            
            // Sync to Drive if enabled
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            generateAccountOptions();
            applyToAll();
            renderSettingsPage();
            updateDisplay();
        }
        
        function editAccount(accountId) {
            const acc = ACCOUNTS[accountId];
            if (!acc) return;
            
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="closeEditAccountModal(event)">
                    <div class="card" onclick="event.stopPropagation()" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h2>‚úèÔ∏è Edit Account</h2>
                        <p style="color:#7f8c8d; margin-bottom:20px; font-size:0.95em;">Update account settings. Trade history will be preserved.</p>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Account Name</label>
                                <input type="text" id="edit-acc-name" value="${acc.name}">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Account Size ($)</label>
                                <input type="number" id="edit-acc-size" value="${acc.size}">
                            </div>
                            <div class="input-group">
                                <label>Initial Balance ($)</label>
                                <input type="number" id="edit-acc-initialBalance" value="${acc.initialBalance}">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Max Drawdown ($)</label>
                                <input type="number" id="edit-acc-maxDrawdown" value="${acc.maxDrawdown}">
                            </div>
                            <div class="input-group">
                                <label>Profit Target ($)</label>
                                <input type="number" id="edit-acc-profitTarget" value="${acc.profitTarget || ''}" placeholder="Optional">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Initial Drawdown ($)</label>
                                <input type="number" id="edit-acc-initialDrawdown" value="${acc.initialDrawdown}">
                            </div>
                            <div class="input-group">
                                <label>P&L Multiplier</label>
                                <select id="edit-acc-multiplier">
                                    <option value="1" ${acc.multiplier === 1 ? 'selected' : ''}>1x (50k base)</option>
                                    <option value="2" ${acc.multiplier === 2 ? 'selected' : ''}>2x (100k)</option>
                                    <option value="3" ${acc.multiplier === 3 ? 'selected' : ''}>3x (150k)</option>
                                    <option value="4" ${acc.multiplier === 4 ? 'selected' : ''}>4x (200k)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="saveEditedAccount('${accountId}')" style="flex: 1;">Save Changes</button>
                            <button class="btn" onclick="closeEditAccountModal()" style="flex: 1; background: #95a5a6;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'editAccountModal';
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
        }
        
        function closeEditAccountModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('editAccountModal');
            if (modal) modal.remove();
        }
        
        function saveEditedAccount(accountId) {
            const name = document.getElementById('edit-acc-name').value.trim();
            const size = parseFloat(document.getElementById('edit-acc-size').value);
            const initialBalance = parseFloat(document.getElementById('edit-acc-initialBalance').value);
            const maxDrawdown = parseFloat(document.getElementById('edit-acc-maxDrawdown').value);
            const profitTargetVal = document.getElementById('edit-acc-profitTarget').value;
            const profitTarget = profitTargetVal ? parseFloat(profitTargetVal) : null;
            const initialDrawdown = parseFloat(document.getElementById('edit-acc-initialDrawdown').value) || 0;
            const multiplier = parseFloat(document.getElementById('edit-acc-multiplier').value);
            
            if (!name || isNaN(size) || isNaN(initialBalance) || isNaN(maxDrawdown)) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Update account (preserve minRisk/maxRisk or recalculate)
            ACCOUNTS[accountId] = {
                ...ACCOUNTS[accountId],
                name, size, initialBalance, maxDrawdown, profitTarget,
                initialDrawdown, multiplier,
                minRisk: Math.round(size * 0.004),
                maxRisk: Math.round(size * 0.005)
            };
            
            saveAccounts();
            closeEditAccountModal();
            generateAccountOptions();
            renderSettingsPage();
            updateDisplay();
            alert(`‚úÖ Account "${name}" updated!`);
        }
        
        function addAdjustment() {
            const accountId = document.getElementById('adj-account').value;
            const newBalance = parseFloat(document.getElementById('adj-amount').value);
            const date = document.getElementById('adj-date').value;
            const note = document.getElementById('adj-note').value || 'Balance adjustment';
            
            if (!accountId || isNaN(newBalance) || !date) {
                alert('Please fill in account, current balance, and date');
                return;
            }
            
            // Calculate current balance from existing trades and payouts
            const account = ACCOUNTS[accountId];
            const accountTrades = trades.filter(t => t.account === accountId);
            const totalPnl = accountTrades.reduce((sum, t) => sum + t.pnl, 0);
            const accountPayouts = payouts.filter(p => p.accountId === accountId);
            const totalPayouts = accountPayouts.reduce((sum, p) => sum + (p.grossAmount || p.amount || 0), 0);
            const currentBalance = account.initialBalance + totalPnl - totalPayouts;
            
            // The adjustment is the difference
            const amount = newBalance - currentBalance;
            
            if (Math.abs(amount) < 0.01) {
                alert(`Balance is already at that value.\n\nCalculated current balance: $${currentBalance.toFixed(2)}\nYou entered: $${newBalance.toFixed(2)}\nDifference: $${amount.toFixed(2)}\n\nNo adjustment needed.`);
                return;
            }
            
            const timestamp = Date.now();
            const adjustment = {
                id: timestamp,
                batchId: timestamp,
                account: accountId,
                type: 'adjustment',
                result: 'adjustment',
                pnl: amount,
                risk: 0,
                date: date,
                note: `üîß ${note}`,
                timestamp: new Date().toISOString()
            };
            
            trades.push(adjustment);
            saveTradesToLocalStorage();
            
            // Also sync to Drive if enabled
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            document.getElementById('adj-amount').value = '';
            document.getElementById('adj-note').value = '';
            
            renderSettingsPage();
            updateDisplay();
            alert(`‚úÖ Adjusted ${ACCOUNTS[accountId].name}\n\nPrevious balance: $${currentBalance.toFixed(2)}\nNew balance: $${newBalance.toFixed(2)}\nAdjustment: ${amount >= 0 ? '+' : ''}$${amount.toFixed(2)}\n\nThis adjustment is included in all P&L displays.`);
        }
        
        function updateAdjustmentBalance() {
            const accountIdEl = document.getElementById('adj-account');
            const amountEl = document.getElementById('adj-amount');
            
            if (!accountIdEl || !amountEl) return; // Elements don't exist yet
            
            const accountId = accountIdEl.value;
            if (!accountId) return;
            
            const account = ACCOUNTS[accountId];
            const accountTrades = trades.filter(t => t.account === accountId);
            const totalPnl = accountTrades.reduce((sum, t) => sum + t.pnl, 0);
            const accountPayouts = payouts.filter(p => p.accountId === accountId);
            const totalPayouts = accountPayouts.reduce((sum, p) => sum + (p.grossAmount || p.amount || 0), 0);
            const currentBalance = account.initialBalance + totalPnl - totalPayouts;
            
            // Pre-fill with current balance
            amountEl.value = currentBalance.toFixed(2);
            
            console.log(`Updated balance for ${account.name}: $${currentBalance.toFixed(2)} (Payouts: $${totalPayouts.toFixed(2)})`);
        }
        
        function deleteAdjustment(id) {
            if (!confirm('Remove this adjustment?')) return;
            
            // Convert id to number to ensure comparison works
            const adjustmentId = Number(id);
            
            // Remove from trades array
            trades = trades.filter(t => Number(t.id) !== adjustmentId);
            
            // Save to localStorage
            saveTradesToLocalStorage();
            
            // Sync to Drive
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            // Force complete UI refresh
            renderSettingsPage();
            updateDisplay();
            
            // Force update the adjustment balance field
            setTimeout(() => {
                updateAdjustmentBalance();
            }, 100);
            
            console.log('Deleted adjustment', adjustmentId, 'Remaining trades:', trades.length);
        }
        
        function renderSettingsPage() {
            // Populate account dropdown for adjustments
            const adjSelect = document.getElementById('adj-account');
            if (adjSelect) {
                const currentAccountId = adjSelect.value; // Preserve current selection
                adjSelect.innerHTML = Object.keys(ACCOUNTS).map(id =>
                    `<option value="${id}">${ACCOUNTS[id].name}</option>`
                ).join('');
                
                // Restore selection if it still exists
                if (currentAccountId && ACCOUNTS[currentAccountId]) {
                    adjSelect.value = currentAccountId;
                }
                
                // Add event listener to update current balance when account changes
                adjSelect.onchange = function() {
                    updateAdjustmentBalance();
                };
                
                // Always update balance to reflect current state (including payouts)
                // Use setTimeout to ensure DOM is ready
                setTimeout(() => {
                    updateAdjustmentBalance();
                }, 50);
            }
            
            // Render symbol list
            const symbolListEl = document.getElementById('settings-symbolList');
            if (symbolListEl) {
                if (SYMBOLS.length === 0) {
                    symbolListEl.innerHTML = '<div class="no-data" style="padding:12px 0;">No symbols defined</div>';
                } else {
                    symbolListEl.innerHTML = `<div style="display:flex; flex-wrap:wrap; gap:8px;">
                        ${SYMBOLS.map(s => `
                            <div style="display:flex; align-items:center; gap:6px; background:#e8f0fe; border-radius:20px; padding:6px 14px;">
                                <span style="font-weight:700; color:#1a56db; font-size:0.95em;">${s}</span>
                                <button onclick="deleteSymbol('${s}')" style="background:none; border:none; cursor:pointer; color:#7f8c8d; font-size:0.9em; padding:0; line-height:1;" onmouseover="this.style.color='#e74c3c'" onmouseout="this.style.color='#7f8c8d'">‚úï</button>
                            </div>
                        `).join('')}
                    </div>`;
                }
            }
            const modelListEl = document.getElementById('settings-modelList');
            if (modelListEl) {
                if (Object.keys(MODELS).length === 0) {
                    modelListEl.innerHTML = '<div class="no-data" style="padding:20px 0;">No models defined yet</div>';
                } else {
                    modelListEl.innerHTML = Object.keys(MODELS).map(id => {
                        const m = MODELS[id];
                        const usedCount = trades.filter(t => t.model === id).length;
                        return `
                            <div id="model-row-${id}" style="display:flex; justify-content:space-between; align-items:center; padding:14px 0; border-bottom:1px solid #ecf0f1; gap:10px; flex-wrap:wrap;">
                                <div style="flex:1;">
                                    <div style="font-weight:700; color:#2c3e50; font-size:1.05em;">${m.name}</div>
                                    ${m.description ? `<div style="font-size:0.88em; color:#7f8c8d; margin-top:3px;">${m.description}</div>` : '<div style="font-size:0.88em; color:#bdc3c7; margin-top:3px; font-style:italic;">No description</div>'}
                                    <div style="font-size:0.8em; color:#aaa; margin-top:3px;">${usedCount} trade${usedCount !== 1 ? 's' : ''} logged</div>
                                </div>
                                <div style="display:flex; gap:8px;">
                                    <button class="btn" onclick="startEditModel('${id}')" style="width:auto; padding:8px 16px; margin:0; font-size:0.9em; background:linear-gradient(135deg,#f39c12,#e67e22);">Edit</button>
                                    <button class="btn btn-danger" onclick="deleteModel('${id}')" style="width:auto; padding:8px 16px; margin:0; font-size:0.9em;">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            
            // Render accounts list
            const listEl = document.getElementById('settings-accountList');
            if (!listEl) return;
            
            listEl.innerHTML = Object.keys(ACCOUNTS).map(id => {
                const acc = ACCOUNTS[id];
                const stats = calculateAccountStats(id);
                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #ecf0f1; gap:10px;">
                        <div style="flex:1;">
                            <div style="font-weight:700; color:#2c3e50; font-size:1.05em;">${acc.name}</div>
                            <div style="font-size:0.88em; color:#7f8c8d; margin-top:3px;">
                                Size: $${acc.size.toLocaleString()} &nbsp;|&nbsp; 
                                Max DD: $${acc.maxDrawdown.toLocaleString()} &nbsp;|&nbsp;
                                Multiplier: ${acc.multiplier}x &nbsp;|&nbsp;
                                Balance: <span style="font-weight:600; color:${stats.currentProfit >= 0 ? '#27ae60' : '#e74c3c'}">$${stats.currentBalance.toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn" onclick="editAccount('${id}')" style="width:auto; padding:8px 18px; margin:0; font-size:0.9em; background:#3498db;">Edit</button>
                            <button class="btn btn-danger" onclick="deleteAccount('${id}')" style="width:auto; padding:8px 18px; margin:0; font-size:0.9em;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Render adjustment history
            const adjHistory = document.getElementById('adj-history');
            if (!adjHistory) return;
            const adjustments = trades.filter(t => t.type === 'adjustment').sort((a,b) => b.id - a.id);
            
            // Update arrow label count
            const arrow = document.getElementById('adj-history-arrow');
            if (arrow) arrow.textContent = adjHistory.style.display === 'none' 
                ? `‚ñº Show (${adjustments.length})` 
                : `‚ñ≤ Hide (${adjustments.length})`;
            
            if (adjustments.length === 0) {
                adjHistory.innerHTML = '<div style="padding:12px; color:#aaa; font-size:0.9em;">No adjustments yet</div>';
                return;
            }
            adjHistory.innerHTML = `
                <div style="border:1px solid #e0e0e0; border-radius:8px; overflow:hidden;">
                    <table style="width:100%; border-collapse:collapse; font-size:0.9em;">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:10px 12px; text-align:left; color:#7f8c8d; font-weight:600; border-bottom:1px solid #e0e0e0;">Account</th>
                                <th style="padding:10px 12px; text-align:left; color:#7f8c8d; font-weight:600; border-bottom:1px solid #e0e0e0;">Date</th>
                                <th style="padding:10px 12px; text-align:left; color:#7f8c8d; font-weight:600; border-bottom:1px solid #e0e0e0;">Note</th>
                                <th style="padding:10px 12px; text-align:right; color:#7f8c8d; font-weight:600; border-bottom:1px solid #e0e0e0;">Amount</th>
                                <th style="padding:10px 12px; text-align:center; color:#7f8c8d; font-weight:600; border-bottom:1px solid #e0e0e0;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${adjustments.map((a, i) => `
                                <tr style="background:${i % 2 === 0 ? '#fff' : '#fafafa'}; border-bottom:1px solid #f0f0f0;">
                                    <td style="padding:9px 12px; font-weight:600; color:#2c3e50;">${ACCOUNTS[a.account] ? ACCOUNTS[a.account].name : 'Unknown'}</td>
                                    <td style="padding:9px 12px; color:#7f8c8d;">${formatDate(a.date)}</td>
                                    <td style="padding:9px 12px; color:#888;">${a.note}</td>
                                    <td style="padding:9px 12px; text-align:right; font-weight:700; color:${a.pnl >= 0 ? '#27ae60' : '#e74c3c'};">${a.pnl >= 0 ? '+' : ''}$${a.pnl.toFixed(2)}</td>
                                    <td style="padding:9px 12px; text-align:center;"><button class="delete-btn" onclick="deleteAdjustment(${a.id})">‚úï</button></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        // ‚îÄ‚îÄ END SETTINGS FUNCTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function generateSymbolOptions() {
            const select = document.getElementById('tradeSymbol');
            const current = select.value;
            select.innerHTML = SYMBOLS.map(s => `<option value="${s}">${s}</option>`).join('');
            if (SYMBOLS.includes(current)) select.value = current;
        }
        
        function generateModelOptions() {
            const select = document.getElementById('tradeModel');
            const current = select.value;
            select.innerHTML = Object.keys(MODELS).map(id => 
                `<option value="${id}">${MODELS[id].name}</option>`
            ).join('');
            // Restore selection if still valid
            if (MODELS[current]) select.value = current;
        }
        
        function generateAccountOptions() {
            const menu = document.getElementById('dropdownMenu');
            menu.innerHTML = Object.keys(ACCOUNTS).map(accountId => {
                const account = ACCOUNTS[accountId];
                return `
                    <div class="dropdown-item" onclick="toggleAccountCheck(event, '${accountId}')">
                        <input type="checkbox" id="acc_${accountId}" value="${accountId}" onchange="updateDropdownText(); updateBatchPreview();">
                        <label for="acc_${accountId}">${account.name}</label>
                    </div>
                `;
            }).join('');
        }
        
        function toggleDropdown() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('open');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.custom-dropdown');
            const perfDropdown = document.getElementById('perfDropdownMenu');
            
            if (dropdown && !dropdown.contains(event.target)) {
                document.getElementById('dropdownMenu').classList.remove('open');
            }
            
            if (perfDropdown && !event.target.closest('#perfDropdownMenu') && !event.target.closest('[onclick*="togglePerfDropdown"]')) {
                perfDropdown.classList.remove('open');
            }
        });
        
        function toggleAccountCheck(event, accountId) {
            // Prevent the click from bubbling when clicking the checkbox itself
            if (event.target.tagName === 'INPUT') {
                return;
            }
            event.stopPropagation();
            
            const checkbox = document.getElementById('acc_' + accountId);
            checkbox.checked = !checkbox.checked;
            updateDropdownText();
            updateBatchPreview();
        }
        
        function updateDropdownText() {
            const checkboxes = document.querySelectorAll('#dropdownMenu input[type="checkbox"]:checked');
            const text = document.getElementById('dropdownText');
            
            if (checkboxes.length === 0) {
                text.textContent = 'Click to select accounts...';
            } else if (checkboxes.length === Object.keys(ACCOUNTS).length) {
                text.textContent = 'All accounts selected (' + checkboxes.length + ')';
            } else {
                text.textContent = checkboxes.length + ' account(s) selected';
            }
        }
        
        function applyToAll() {
            document.querySelectorAll('#dropdownMenu input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updateDropdownText();
            updateBatchPreview();
        }
        
        function clearSelection() {
            document.querySelectorAll('#dropdownMenu input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updateDropdownText();
            updateBatchPreview();
        }
        
        // Update batch preview when inputs change
        document.getElementById('tradePnl').addEventListener('input', updateBatchPreview);
        
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const header = section.previousElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (section.style.display === 'none') {
                section.style.display = 'block';
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function updateResultHint() {
            const result = document.getElementById('tradeResult').value;
            const hint = document.getElementById('resultHint');
            
            if (result === 'be_win') {
                hint.innerHTML = 'üí° BE/WIN: Went BE initially, eventually won. P&L recorded but NOT counted in win rate.';
                hint.style.color = '#f39c12';
            } else if (result === 'be_loss') {
                hint.innerHTML = 'üí° BE/LOSS: Went BE initially, eventually lost. P&L recorded but NOT counted in win rate.';
                hint.style.color = '#f39c12';
            } else {
                hint.innerHTML = 'üí° Risk is auto-calculated as 1:1 RR (Risk = |P&L|)';
                hint.style.color = '#7f8c8d';
            }
        }
        
        // Initialize result hint
        updateResultHint();
        
        function updateBatchPreview() {
            const checkboxes = document.querySelectorAll('#dropdownMenu input[type="checkbox"]:checked');
            const selectedAccounts = Array.from(checkboxes).map(cb => cb.value);
            
            const basePnl = parseFloat(document.getElementById('tradePnl').value) || 0;
            const riskSize = parseFloat(document.getElementById('tradeRiskSize').value) || 1;
            const baseRisk = Math.abs(basePnl);
            const rLabel = riskSize === 1 ? '1R' : '0.5R';
            
            const previewDiv = document.getElementById('batchPreview');
            const alertDiv = document.getElementById('riskAlert');
            
            if (selectedAccounts.length === 0) {
                previewDiv.innerHTML = '';
                alertDiv.innerHTML = '';
                return;
            }
            
            let previewHtml = `<div class="alert alert-info" style="margin-top: 15px;"><strong>Trade Preview (${rLabel}):</strong><br>`;
            let hasWarning = false;
            let hasDanger = false;
            
            selectedAccounts.forEach(accountId => {
                const account = ACCOUNTS[accountId];
                const actualPnl = basePnl * account.multiplier;
                const actualRisk = baseRisk * account.multiplier;
                const rValue = actualRisk > 0 ? (actualPnl / actualRisk) * riskSize : 0;
                
                previewHtml += `${account.name}: `;
                previewHtml += actualPnl >= 0 ? `+$${actualPnl.toFixed(2)}` : `$${actualPnl.toFixed(2)}`;
                previewHtml += ` (${rValue >= 0 ? '+' : ''}${rValue.toFixed(2)}R, Risk: $${actualRisk.toFixed(0)})<br>`;
                
                if (actualRisk > account.maxRisk) hasDanger = true;
                else if (actualRisk < account.minRisk && actualRisk > 0) hasWarning = true;
            });
            
            previewHtml += '</div>';
            previewDiv.innerHTML = previewHtml;
            alertDiv.innerHTML = '';
        }
        
        function logBatchTrade() {
            const checkboxes = document.querySelectorAll('#dropdownMenu input[type="checkbox"]:checked');
            const selectedAccounts = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedAccounts.length === 0) {
                alert('Please select at least one account');
                return;
            }
            
            const type = document.getElementById('tradeType').value;
            const result = document.getElementById('tradeResult').value;
            const symbol = document.getElementById('tradeSymbol').value;
            const direction = document.getElementById('tradeDirection').value;
            const model = document.getElementById('tradeModel').value;
            const grade = document.getElementById('tradeGrade').value;
            const riskSize = parseFloat(document.getElementById('tradeRiskSize').value); // 1 or 0.5
            const basePnl = parseFloat(document.getElementById('tradePnl').value);
            const baseRisk = Math.abs(basePnl); // 1:1 RR
            const date = document.getElementById('tradeDate').value;
            const entryTime = document.getElementById('tradeEntryTime').value;
            const exitTime = document.getElementById('tradeExitTime').value;
            const note = document.getElementById('tradeNote').value;
            const screenshotFile = document.getElementById('tradeScreenshot').files[0];
            
            if (isNaN(basePnl) || !date) {
                alert('Please enter P&L and date');
                return;
            }
            
            // Convert screenshot to base64 if provided
            const processScreenshot = new Promise((resolve, reject) => {
                if (screenshotFile) {
                    // Compress image before storing
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Resize to max 1200px width while maintaining aspect ratio
                        const maxWidth = 1200;
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to JPEG with 0.7 quality for compression
                        const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressedData);
                    };
                    img.onerror = function() {
                        reject(new Error('Failed to load screenshot image'));
                    };
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                    };
                    reader.onerror = function() {
                        reject(new Error('Failed to read screenshot file'));
                    };
                    reader.readAsDataURL(screenshotFile);
                } else {
                    resolve(null);
                }
            });
            
            processScreenshot.then(screenshotData => {
                const timestamp = Date.now();
                
                selectedAccounts.forEach((accountId, index) => {
                    const account = ACCOUNTS[accountId];
                    const actualPnl = basePnl * account.multiplier;
                    const actualRisk = baseRisk * account.multiplier;
                    // R value: pnl / (risk / riskSize) ‚Äî e.g. half risk win = +0.5R, full risk loss = -1R
                    const rValue = actualRisk > 0 ? (actualPnl / actualRisk) * riskSize : 0;
                    
                    const trade = {
                        id: timestamp + index,
                        batchId: timestamp,
                        account: accountId,
                        type: type,
                        result: result,
                        symbol: symbol,
                        direction: direction,
                        model: model,
                        grade: grade,
                        riskSize: riskSize,
                        rValue: rValue,
                        pnl: actualPnl,
                        risk: actualRisk,
                        date: date,
                        entryTime: entryTime,
                        exitTime: exitTime,
                        screenshot: screenshotData,
                        note: note,
                        timestamp: new Date().toISOString()
                    };
                    
                    trades.push(trade);
                });
                
                // Save to localStorage WITHOUT screenshots (to avoid quota)
                saveTradesToLocalStorage();
                
                // Trigger Drive sync for full data INCLUDING screenshots
                if (useDriveSync) {
                    clearTimeout(window.syncTimeout);
                    window.syncTimeout = setTimeout(syncToDrive, 1000);
                }
                
                // Clear inputs
                document.getElementById('tradePnl').value = '';
                document.getElementById('tradeNote').value = '';
                document.getElementById('tradeScreenshot').value = '';
                document.getElementById('batchPreview').innerHTML = '';
                document.getElementById('riskAlert').innerHTML = '';
                
                // Reset to defaults
                document.getElementById('tradeType').value = 'system';
                document.getElementById('tradeResult').value = 'win';
                document.getElementById('tradeDirection').value = 'long';
                document.getElementById('tradeRiskSize').value = '1';
                document.getElementById('tradeModel').value = 'model1';
                document.getElementById('tradeGrade').value = 'A';
                updateResultHint();
                
                // Don't clear selection - keep accounts selected
                
                const now = new Date();
                document.getElementById('tradeDate').valueAsDate = now;
                document.getElementById('tradeEntryTime').value = now.toTimeString().slice(0,5);
                document.getElementById('tradeExitTime').value = now.toTimeString().slice(0,5);
                
                updateDisplay();
                
                alert(`‚úÖ Trade added to ${selectedAccounts.length} account(s)`);
            }).catch(error => {
                console.error('Error processing trade:', error);
                if (error.name === 'QuotaExceededError') {
                    alert('‚ö†Ô∏è Storage quota exceeded! Your browser storage is full.\n\nTips:\n- Use smaller screenshots\n- Delete old trades you no longer need\n- Consider exporting data and starting fresh');
                } else {
                    alert('‚ö†Ô∏è Error adding trade: ' + error.message);
                }
            });
        }
        
        function deleteTrade(id) {
            if (confirm('Delete this trade from all accounts?')) {
                const trade = trades.find(t => t.id === id);
                if (currentFilter === 'system' || currentFilter === 'offsystem') {
                    // Delete entire batch (all accounts)
                    const batchKey = String(trade ? (trade.batchId || Math.floor(trade.id / 10) * 10) : id);
                    trades = trades.filter(t => {
                        const tBatchKey = String(t.batchId || Math.floor(t.id / 10) * 10);
                        return tBatchKey !== batchKey;
                    });
                } else {
                    // Delete just this one account's trade
                    trades = trades.filter(t => t.id !== id);
                }
                
                saveTradesToLocalStorage();
                
                if (useDriveSync) {
                    clearTimeout(window.syncTimeout);
                    window.syncTimeout = setTimeout(syncToDrive, 2000);
                }
                
                updateDisplay();
            }
            return false;
        }
        
        function editTrade(id, filter) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;
            
            // Build edit form in modal
            const isBatch = filter === 'system' || filter === 'offsystem';
            const batchKey = String(trade.batchId || Math.floor(trade.id / 10) * 10);
            const batchTrades = isBatch 
                ? trades.filter(t => String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey)
                : [trade];
            
            const modalHtml = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="closeEditModal(event)">
                    <div class="card" onclick="event.stopPropagation()" style="max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <h2>‚úèÔ∏è Edit Trade ${isBatch ? `(${batchTrades.length} accounts)` : ''}</h2>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Type</label>
                                <select id="edit-type">
                                    <option value="system" ${trade.type === 'system' ? 'selected' : ''}>System</option>
                                    <option value="offsystem" ${trade.type === 'offsystem' ? 'selected' : ''}>Off-System</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Result</label>
                                <select id="edit-result">
                                    <option value="win" ${trade.result === 'win' ? 'selected' : ''}>Win</option>
                                    <option value="loss" ${trade.result === 'loss' ? 'selected' : ''}>Loss</option>
                                    <option value="be_win" ${trade.result === 'be_win' ? 'selected' : ''}>BE (counted as win)</option>
                                    <option value="be_loss" ${trade.result === 'be_loss' ? 'selected' : ''}>BE (counted as loss)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Symbol</label>
                                <select id="edit-symbol">
                                    ${SYMBOLS.map(s => `<option value="${s}" ${trade.symbol === s ? 'selected' : ''}>${s}</option>`).join('')}
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Direction</label>
                                <select id="edit-direction">
                                    <option value="long" ${trade.direction === 'long' ? 'selected' : ''}>üìà LONG</option>
                                    <option value="short" ${trade.direction === 'short' ? 'selected' : ''}>üìâ SHORT</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Model</label>
                                <select id="edit-model">
                                    ${Object.keys(MODELS).map(id => `<option value="${id}" ${trade.model === id ? 'selected' : ''}>${MODELS[id].name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Grade</label>
                                <select id="edit-grade">
                                    <option value="A" ${trade.grade === 'A' ? 'selected' : ''}>A - Excellent</option>
                                    <option value="B" ${trade.grade === 'B' ? 'selected' : ''}>B - Good</option>
                                    <option value="C" ${trade.grade === 'C' ? 'selected' : ''}>C - Average</option>
                                    <option value="troll" ${trade.grade === 'troll' ? 'selected' : ''}>Troll - Bad</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Risk Size</label>
                                <select id="edit-riskSize">
                                    <option value="1" ${trade.riskSize === 1 ? 'selected' : ''}>Full Risk (1R)</option>
                                    <option value="0.5" ${trade.riskSize === 0.5 ? 'selected' : ''}>Half Risk (0.5R)</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>P&L per 50k ($)</label>
                                <input type="number" id="edit-pnl" step="0.01" value="${(trade.pnl / (ACCOUNTS[trade.account]?.multiplier || 1)).toFixed(2)}">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Date</label>
                                <input type="date" id="edit-date" value="${trade.date}">
                            </div>
                            <div class="input-group">
                                <label>Entry Time</label>
                                <input type="time" id="edit-entryTime" value="${trade.entryTime || ''}">
                            </div>
                        </div>
                        
                        <div class="input-row">
                            <div class="input-group">
                                <label>Exit Time</label>
                                <input type="time" id="edit-exitTime" value="${trade.exitTime || ''}">
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <label>Note</label>
                            <input type="text" id="edit-note" value="${trade.note || ''}">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="saveEditedTrade(${id}, '${filter}')" style="flex: 1;">Save Changes</button>
                            <button class="btn" onclick="closeEditModal()" style="flex: 1; background: #95a5a6;">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'editTradeModal';
            modal.innerHTML = modalHtml;
            document.body.appendChild(modal);
        }
        
        function closeEditModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('editTradeModal');
            if (modal) modal.remove();
        }
        
        function saveEditedTrade(id, filter) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;
            
            const isBatch = filter === 'system' || filter === 'offsystem';
            const batchKey = String(trade.batchId || Math.floor(trade.id / 10) * 10);
            const tradesToEdit = isBatch
                ? trades.filter(t => String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey)
                : [trade];
            
            // Read new values
            const type = document.getElementById('edit-type').value;
            const result = document.getElementById('edit-result').value;
            const symbol = document.getElementById('edit-symbol').value;
            const direction = document.getElementById('edit-direction').value;
            const model = document.getElementById('edit-model').value;
            const grade = document.getElementById('edit-grade').value;
            const riskSize = parseFloat(document.getElementById('edit-riskSize').value);
            const basePnl = parseFloat(document.getElementById('edit-pnl').value);
            const date = document.getElementById('edit-date').value;
            const entryTime = document.getElementById('edit-entryTime').value;
            const exitTime = document.getElementById('edit-exitTime').value;
            const note = document.getElementById('edit-note').value;
            
            if (isNaN(basePnl)) {
                alert('Please enter valid P&L');
                return;
            }
            
            // Update all trades in batch
            tradesToEdit.forEach(t => {
                const account = ACCOUNTS[t.account];
                const actualPnl = basePnl * account.multiplier;
                const baseRisk = Math.abs(basePnl);
                const actualRisk = baseRisk * account.multiplier;
                const rValue = actualRisk > 0 ? (actualPnl / actualRisk) * riskSize : 0;
                
                t.type = type;
                t.result = result;
                t.symbol = symbol;
                t.direction = direction;
                t.model = model;
                t.grade = grade;
                t.riskSize = riskSize;
                t.rValue = rValue;
                t.pnl = actualPnl;
                t.risk = actualRisk;
                t.date = date;
                t.entryTime = entryTime;
                t.exitTime = exitTime;
                t.note = note;
            });
            
            saveTradesToLocalStorage();
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            closeEditModal();
            updateDisplay();
        }
        
        function filterTrades(filter, clickedElement) {
            currentFilter = filter;
            generateTradeHistoryFilters();
            displayTrades();
        }
        
        function clearAllData() {
            console.log('clearAllData called');
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL trades and reset all accounts. This CANNOT be undone. Are you absolutely sure?')) {
                if (confirm('Really? All your trade history will be lost forever.')) {
                    trades = [];
                    localStorage.removeItem('propTrades');
                    updateDisplay();
                }
            }
            return false;
        }
        
        function calculateAccountStats(accountId) {
            const account = ACCOUNTS[accountId];
            const accountTrades = trades.filter(t => t.account === accountId);
            const realTrades = accountTrades.filter(t => t.type !== 'adjustment');
            
            const totalPnl = accountTrades.reduce((sum, t) => sum + t.pnl, 0); // includes adjustments
            
            // Subtract payouts from this account (GROSS amount withdrawn)
            const accountPayouts = payouts.filter(p => p.accountId === accountId);
            const totalPayouts = accountPayouts.reduce((sum, p) => sum + (p.grossAmount || p.amount || 0), 0);
            
            const currentBalance = account.initialBalance + totalPnl - totalPayouts;
            const currentProfit = currentBalance - account.size;
            
            console.log(`Calculate stats for ${account.name}:`, {
                initialBalance: account.initialBalance,
                totalPnl,
                totalPayouts,
                currentBalance,
                adjustments: accountTrades.filter(t => t.type === 'adjustment').length
            });
            
            // Calculate drawdown
            // Peak starts at initialBalance (already accounts for profits before tracking started)
            // We replay all EOD closes and track worst drawdown from peak
            // IMPORTANT: Only use realTrades (exclude adjustments) for drawdown calc
            const tradesByDate = {};
            realTrades.forEach(trade => {
                if (!tradesByDate[trade.date]) tradesByDate[trade.date] = [];
                tradesByDate[trade.date].push(trade);
            });
            
            const sortedDates = Object.keys(tradesByDate).sort();
            
            let runningBalance = account.initialBalance;
            let peakBalance = account.initialBalance;
            
            sortedDates.forEach(date => {
                const dailyPnl = tradesByDate[date].reduce((sum, t) => sum + t.pnl, 0);
                runningBalance += dailyPnl;
                if (runningBalance > peakBalance) peakBalance = runningBalance;
            });
            
            // How far are we from peak right now
            const currentDDfromPeak = peakBalance - runningBalance;
            
            // The worst drawdown ever = max(initialDrawdown, currentDDfromPeak)
            // But we need to also check intermediate days, not just final state
            // Re-run to find actual worst
            let runningBalance2 = account.initialBalance;
            let peakBalance2 = account.initialBalance;
            let worstDD = account.initialDrawdown;
            
            sortedDates.forEach(date => {
                const dailyPnl = tradesByDate[date].reduce((sum, t) => sum + t.pnl, 0);
                runningBalance2 += dailyPnl;
                if (runningBalance2 > peakBalance2) peakBalance2 = runningBalance2;
                const dd = peakBalance2 - runningBalance2;
                if (dd > worstDD) worstDD = dd;
            });
            
            // Cushion = how much balance can drop from HERE before hitting the drawdown limit
            // Drawdown limit means: balance cannot drop more than maxDrawdown from peak
            // So floor = peakBalance - maxDrawdown
            // Cushion = currentBalance - floor = currentBalance - peakBalance + maxDrawdown
            const cushionRemaining = Math.max(0, runningBalance - (peakBalance - account.maxDrawdown));
            const ddConsumed = account.maxDrawdown - cushionRemaining;
            const ddPercent = Math.max(0, Math.min(100, (ddConsumed / account.maxDrawdown) * 100));
            
            let profitPercent = 0;
            if (account.profitTarget) {
                profitPercent = Math.min((currentProfit / account.profitTarget) * 100, 100);
            }
            
            let status = 'healthy';
            if (ddPercent > 75) status = 'danger';
            else if (ddPercent > 50) status = 'warning';
            
            return {
                currentBalance, currentProfit,
                currentDrawdown: ddConsumed,
                ddRemaining: cushionRemaining,
                ddPercent, profitPercent, status,
                tradeCount: realTrades.length
            };
        }
        
        function renderAccountCard(accountId) {
            const account = ACCOUNTS[accountId];
            const stats = calculateAccountStats(accountId);
            
            const statusLabel = {
                'healthy': '‚úÖ Healthy',
                'warning': '‚ö†Ô∏è Warning',
                'danger': 'üö® Danger'
            }[stats.status];
            
            const isLucid = accountId.startsWith('lucid');
            
            return `
                <div class="account-card ${stats.status}">
                    <div class="account-header">
                        <div class="account-name">${account.name}</div>
                        <div class="account-status ${stats.status}">${statusLabel}</div>
                    </div>
                    
                    <div class="account-stats">
                        <div class="stat-row">
                            <span class="stat-label">Current Balance</span>
                            <span class="stat-value">$${stats.currentBalance.toLocaleString()}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Profit/Loss</span>
                            <span class="stat-value ${stats.currentProfit >= 0 ? 'positive' : 'negative'}">
                                ${stats.currentProfit >= 0 ? '+' : ''}$${stats.currentProfit.toFixed(2)}
                            </span>
                        </div>
                    </div>
                    
                    ${account.profitTarget ? `
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Profit Target: $${stats.currentProfit.toFixed(0)} / $${account.profitTarget}</span>
                            <span>${stats.profitPercent.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill profit" style="width: ${stats.profitPercent}%">
                                ${stats.profitPercent > 15 ? stats.profitPercent.toFixed(0) + '%' : ''}
                            </div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85em; color: #7f8c8d;">
                            ${stats.profitPercent >= 100 ? 'üéâ Target reached!' : `$${(account.profitTarget - stats.currentProfit).toFixed(0)} to go`}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Drawdown: $${stats.currentDrawdown.toFixed(0)} / $${account.maxDrawdown}</span>
                            <span>${stats.ddPercent.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill drawdown" style="width: ${stats.ddPercent}%">
                                ${stats.ddPercent > 15 ? stats.ddPercent.toFixed(0) + '%' : ''}
                            </div>
                        </div>
                        <div style="margin-top: 5px; font-size: 0.85em; color: ${stats.status === 'danger' ? '#e74c3c' : '#7f8c8d'};">
                            ${stats.ddRemaining > 0 ? `$${stats.ddRemaining.toFixed(0)} cushion remaining` : '‚ö†Ô∏è Max drawdown reached!'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateDisplay() {
            // Render all account cards
            const accountsGrid = document.getElementById('accountsGrid');
            accountsGrid.innerHTML = Object.keys(ACCOUNTS).map(id => renderAccountCard(id)).join('');
            
            // Calculate total profit for current month only
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const monthName = now.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            const monthlyPnl = trades
                .filter(t => t.type !== 'adjustment' && t.date && t.date.startsWith(currentMonth))
                .reduce((sum, t) => sum + t.pnl, 0);
            
            const totalProfitEl = document.getElementById('totalProfit');
            totalProfitEl.textContent = (monthlyPnl >= 0 ? '+' : '') + '$' + monthlyPnl.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            totalProfitEl.style.color = monthlyPnl >= 0 ? '#2ecc71' : '#e74c3c';
            document.getElementById('totalProfitLabel').textContent = `${monthName} ‚Äî All Accounts`;
            
            // Update discipline stats
            updateDisciplineStats();
            
            // Update weekly performance
            updateWeeklyPerformance();
            if (document.getElementById('calendar').classList.contains('active')) renderCalendar();
            
            // Update performance tab
            updatePerformanceTab();
            
            // Generate trade history filter buttons
            generateTradeHistoryFilters();
            
            // Display trades
            displayTrades();
        }
        
        // Returns one entry per batch, with P&L summed across all accounts
        // Excludes adjustment entries - those affect balance only
        function getUniqueTrades() {
            const unique = [];
            const seen = new Set();
            trades.filter(t => t.type !== 'adjustment').forEach(trade => {
                const batchKey = String(trade.batchId || Math.floor(trade.id / 10) * 10);
                if (!seen.has(batchKey)) {
                    seen.add(batchKey);
                    const batch = trades.filter(t => 
                        String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey
                    );
                    unique.push({
                        ...trade,
                        pnl: batch.reduce((sum, t) => sum + t.pnl, 0),
                        accountCount: batch.length
                    });
                }
            });
            return unique;
        }
        
        function renderPerfBreakdown(groups) {
            if (groups.length === 0) return '<div class="no-data">No trades yet</div>';
            return groups.map(g => {
                const winLoss = g.trades.filter(t => t.result === 'win' || t.result === 'loss');
                const wins = g.trades.filter(t => t.result === 'win');
                const winRate = winLoss.length > 0 ? Math.round(wins.length / winLoss.length * 100) : 0;
                const totalPnl = g.trades.reduce((s, t) => s + t.pnl, 0);
                // Calculate R - sum R from wins/losses only (not BE), R is already per batch in unique trades
                const totalR = winLoss.reduce((s, t) => s + (t.rValue || 0), 0);
                const winRateColor = winRate >= 60 ? '#27ae60' : winRate >= 45 ? '#f39c12' : '#e74c3c';
                return `
                    <div style="padding: 14px 0; border-bottom: 1px solid #ecf0f1;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px;">
                            <span style="font-weight:700; color:#2c3e50; font-size:1.05em;">${g.label}</span>
                            <div style="display:flex; align-items:baseline; gap:10px;">
                                <span style="font-weight:700; color:${totalPnl >= 0 ? '#27ae60' : '#e74c3c'};">${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(0)}</span>
                                <span style="font-weight:700; font-size:0.85em; color:${totalR >= 0 ? '#27ae60' : '#e74c3c'}; opacity:0.9;">${totalR >= 0 ? '+' : ''}${totalR.toFixed(2)}R</span>
                            </div>
                        </div>
                        <div style="display:flex; gap:16px; font-size:0.9em; color:#7f8c8d;">
                            <span>${g.trades.length} trade${g.trades.length !== 1 ? 's' : ''}</span>
                            <span style="color:${winRateColor}; font-weight:600;">${winRate}% win rate</span>
                            <span>${wins.length}W / ${winLoss.length - wins.length}L${g.trades.length - winLoss.length > 0 ? ' / ' + (g.trades.length - winLoss.length) + 'BE' : ''}</span>
                        </div>
                        <div style="margin-top: 8px; background:#ecf0f1; border-radius:6px; height:8px; overflow:hidden;">
                            <div style="height:100%; width:${winRate}%; background:${winRateColor}; border-radius:6px; transition: width 0.5s;"></div>
                        </div>
                    </div>`;
            }).join('');
        }
        
        let perfSelectedAccounts = [];
        let perfTimeRange = 'week';
        let perfDiscipline = 'all'; // 'all', 'system', or 'offsystem'
        
        function generatePerfAccountFilter() {
            const menu = document.getElementById('perfDropdownMenu');
            if (!menu) return;
            
            menu.innerHTML = Object.keys(ACCOUNTS).map(id => `
                <label class="dropdown-item">
                    <input type="checkbox" value="${id}" onchange="updatePerfAccountSelection()">
                    <span>${ACCOUNTS[id].name}</span>
                </label>
            `).join('');
        }
        
        function togglePerfDropdown() {
            const menu = document.getElementById('perfDropdownMenu');
            if (menu) menu.classList.toggle('open');
        }
        
        function updatePerfAccountSelection() {
            const checkboxes = document.querySelectorAll('#perfDropdownMenu input[type="checkbox"]:checked');
            perfSelectedAccounts = Array.from(checkboxes).map(cb => cb.value);
            
            const text = document.getElementById('perfDropdownText');
            if (perfSelectedAccounts.length === 0) {
                text.textContent = 'All Accounts';
            } else if (perfSelectedAccounts.length === Object.keys(ACCOUNTS).length) {
                text.textContent = 'All Accounts';
            } else {
                text.textContent = perfSelectedAccounts.map(id => ACCOUNTS[id].name).join(', ');
            }
            
            updatePerformanceTab();
        }
        
        function perfSelectAll(event) {
            if (event) event.stopPropagation();
            document.querySelectorAll('#perfDropdownMenu input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            updatePerfAccountSelection();
        }
        
        function perfClearSelection(event) {
            if (event) event.stopPropagation();
            document.querySelectorAll('#perfDropdownMenu input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            updatePerfAccountSelection();
        }
        
        function setPerfTimeRange(range) {
            perfTimeRange = range;
            document.querySelectorAll('#performance .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updatePerformanceTab();
        }
        
        function setPerfDiscipline(discipline) {
            perfDiscipline = discipline;
            // Remove active from all discipline buttons
            document.getElementById('perf-type-all').classList.remove('active');
            document.getElementById('perf-type-system').classList.remove('active');
            document.getElementById('perf-type-offsystem').classList.remove('active');
            // Add active to clicked button
            document.getElementById(`perf-type-${discipline}`).classList.add('active');
            updatePerformanceTab();
        }
        
        function getFilteredPerfTrades() {
            let filtered = getUniqueTrades();
            
            // Filter by accounts - check if batch contains any selected account
            // AND recalculate P&L to only include selected accounts
            if (perfSelectedAccounts.length > 0) {
                filtered = filtered.filter(uniqueTrade => {
                    // Get all trades in this batch
                    const batchKey = String(uniqueTrade.batchId || Math.floor(uniqueTrade.id / 10) * 10);
                    const batchTrades = trades.filter(t => 
                        String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey
                    );
                    // Keep this batch if ANY trade in it matches selected accounts
                    return batchTrades.some(t => perfSelectedAccounts.includes(t.account));
                }).map(uniqueTrade => {
                    // Recalculate P&L for only the selected accounts
                    const batchKey = String(uniqueTrade.batchId || Math.floor(uniqueTrade.id / 10) * 10);
                    const batchTrades = trades.filter(t => 
                        String(t.batchId || Math.floor(t.id / 10) * 10) === batchKey &&
                        perfSelectedAccounts.includes(t.account)
                    );
                    const filteredPnl = batchTrades.reduce((sum, t) => sum + t.pnl, 0);
                    return {
                        ...uniqueTrade,
                        pnl: filteredPnl,
                        accountCount: batchTrades.length
                    };
                });
            }
            
            // Filter by discipline (system/off-system/all)
            if (perfDiscipline !== 'all') {
                filtered = filtered.filter(t => t.type === perfDiscipline);
            }
            
            // Filter by time range
            if (perfTimeRange !== 'all') {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                let startDate;
                if (perfTimeRange === 'today') {
                    startDate = today;
                } else if (perfTimeRange === 'week') {
                    const day = today.getDay();
                    const diff = day === 0 ? 6 : day - 1; // Mon = 0
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - diff);
                } else if (perfTimeRange === 'month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (perfTimeRange === 'quarter') {
                    const q = Math.floor(now.getMonth() / 3);
                    startDate = new Date(now.getFullYear(), q * 3, 1);
                } else if (perfTimeRange === 'year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }
                
                if (startDate) {
                    const startStr = `${startDate.getFullYear()}-${String(startDate.getMonth()+1).padStart(2,'0')}-${String(startDate.getDate()).padStart(2,'0')}`;
                    filtered = filtered.filter(t => t.date >= startStr);
                }
            }
            
            return filtered;
        }
        
        function updatePerformanceTab() {
            const all = getFilteredPerfTrades();
            if (all.length === 0) {
                ['perf-totalTrades','perf-winRate','perf-totalR','perf-totalPnl','perf-avgWin','perf-avgLoss','perf-rrRatio'].forEach(id => {
                    document.getElementById(id).textContent = '-';
                });
                ['perf-byModel','perf-byGrade','perf-byDirection','perf-discipline','perf-beTrades'].forEach(id => {
                    document.getElementById(id).innerHTML = '<div class="no-data">No trades yet</div>';
                });
                return;
            }
            
            // Only WIN/LOSS count for stats - BE excluded
            const winLoss = all.filter(t => t.result === 'win' || t.result === 'loss');
            const wins = all.filter(t => t.result === 'win');
            const losses = all.filter(t => t.result === 'loss');
            const beTrades = all.filter(t => t.result === 'be_win' || t.result === 'be_loss');
            
            const winRate = winLoss.length > 0 ? Math.round(wins.length / winLoss.length * 100) : 0;
            const totalPnl = all.reduce((s, t) => s + t.pnl, 0);
            const totalR = winLoss.reduce((s, t) => s + (t.rValue || 0), 0); // Only wins/losses, not BE
            const avgWin = wins.length > 0 ? wins.reduce((s, t) => s + t.pnl, 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? losses.reduce((s, t) => s + t.pnl, 0) / losses.length : 0;
            const rr = avgLoss !== 0 ? Math.abs(avgWin / avgLoss).toFixed(2) : '-';
            
            // Top metrics
            document.getElementById('perf-totalTrades').textContent = all.length;
            const wrEl = document.getElementById('perf-winRate');
            wrEl.textContent = winRate + '%';
            wrEl.style.color = winRate >= 60 ? '#27ae60' : winRate >= 45 ? '#f39c12' : '#e74c3c';
            const rEl = document.getElementById('perf-totalR');
            if (rEl) {
                rEl.textContent = (totalR >= 0 ? '+' : '') + totalR.toFixed(2) + 'R';
                rEl.style.color = totalR >= 0 ? '#27ae60' : '#e74c3c';
            }
            const pnlEl = document.getElementById('perf-totalPnl');
            pnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(0);
            pnlEl.style.color = totalPnl >= 0 ? '#27ae60' : '#e74c3c';
            document.getElementById('perf-avgWin').textContent = '$' + avgWin.toFixed(0);
            document.getElementById('perf-avgLoss').textContent = '$' + Math.abs(avgLoss).toFixed(0);
            document.getElementById('perf-rrRatio').textContent = rr;
            
            // By Model
            const modelGroups = Object.keys(MODELS).map(id => ({
                label: MODELS[id].name,
                trades: all.filter(t => t.model === id)
            })).filter(g => g.trades.length > 0);
            document.getElementById('perf-byModel').innerHTML = renderPerfBreakdown(modelGroups);
            
            // By Grade
            const grades = [
                { key: 'A', label: 'üü¢ Grade A' },
                { key: 'B', label: 'üü¢ Grade B' },
                { key: 'C', label: 'üü° Grade C' },
                { key: 'troll', label: 'üî¥ Troll' }
            ];
            const gradeGroups = grades.map(g => ({
                label: g.label,
                trades: all.filter(t => t.grade === g.key)
            })).filter(g => g.trades.length > 0);
            document.getElementById('perf-byGrade').innerHTML = renderPerfBreakdown(gradeGroups);
            
            // By Direction
            const dirGroups = [
                { label: 'üìà Long', trades: all.filter(t => t.direction === 'long') },
                { label: 'üìâ Short', trades: all.filter(t => t.direction === 'short') }
            ].filter(g => g.trades.length > 0);
            document.getElementById('perf-byDirection').innerHTML = renderPerfBreakdown(dirGroups);
            
            // Discipline Impact
            const systemTrades = all.filter(t => t.type === 'system');
            const offsystemTrades = all.filter(t => t.type === 'offsystem');
            const discGroups = [
                { label: '‚úÖ System Trades', trades: systemTrades },
                { label: '‚ùå Off-System Trades', trades: offsystemTrades }
            ].filter(g => g.trades.length > 0);
            document.getElementById('perf-discipline').innerHTML = renderPerfBreakdown(discGroups);
            
            // BE trades
            if (beTrades.length === 0) {
                document.getElementById('perf-beTrades').innerHTML = '<div class="no-data">No BE trades recorded</div>';
            } else {
                const beWins = beTrades.filter(t => t.result === 'be_win');
                const beLosses = beTrades.filter(t => t.result === 'be_loss');
                // Calculate what R would be if BE trades were counted as actual wins/losses
                const beWinR = beWins.reduce((sum, t) => sum + (t.riskSize || 1), 0); // +1R per BE/WIN
                const beLossR = beLosses.reduce((sum, t) => sum + (t.riskSize || 1), 0); // would be -1R per BE/LOSS
                const hypotheticalR = beWinR - beLossR;
                document.getElementById('perf-beTrades').innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:15px;">
                        <div class="stat-box">
                            <div class="value">${beTrades.length}</div>
                            <div class="label">Total BE Trades</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" style="color:#27ae60;">${beWins.length}</div>
                            <div class="label">BE ‚Üí Win</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" style="color:#e74c3c;">${beLosses.length}</div>
                            <div class="label">BE ‚Üí Loss</div>
                        </div>
                        <div class="stat-box">
                            <div class="value" style="color:${hypotheticalR >= 0 ? '#27ae60' : '#e74c3c'};">${hypotheticalR >= 0 ? '+' : ''}${hypotheticalR.toFixed(2)}R</div>
                            <div class="label">If Counted as W/L</div>
                        </div>
                    </div>
                    <p style="margin-top:15px; color:#7f8c8d; font-size:0.95em;">‚ö†Ô∏è BE trades are excluded from win rate and Total R ‚Äî "If Counted" shows hypothetical R if they were treated as wins/losses.</p>
                `;
            }
        }
        
        function updateWeeklyPerformance() {
            const container = document.getElementById('weeklyPerformance');
            
            // Get Monday of current week using LOCAL date (avoid UTC timezone shift)
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon...
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);
            
            // Build local date string YYYY-MM-DD without UTC conversion
            function toLocalDateStr(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }
            
            const todayStr = toLocalDateStr(today);
            
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const dayDates = days.map((_, i) => {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                return d;
            });
            
            // Get unique trades (one per batch), P&L summed across all accounts
            // Only count SYSTEM trades + adjustments
            const unique = getUniqueTrades();
            const systemUnique = unique.filter(t => t.type === 'system');
            const adjustments = trades.filter(t => t.type === 'adjustment');
            
            // Build day data - match using local date string
            const dayData = dayDates.map((date, i) => {
                const dateStr = toLocalDateStr(date);
                const dayTrades = systemUnique.filter(t => t.date === dateStr);
                const dayAdjustments = adjustments.filter(t => t.date === dateStr);
                const pnl = dayTrades.reduce((s, t) => s + t.pnl, 0) + dayAdjustments.reduce((s, t) => s + t.pnl, 0);
                const isToday = dateStr === todayStr;
                const isFuture = dateStr > todayStr;
                return { label: days[i], date, dateStr, dayTrades, pnl, isToday, isFuture };
            });
            
            const weekPnl = dayData.reduce((s, d) => s + d.pnl, 0);
            const tradedDays = dayData.filter(d => d.dayTrades.length > 0).length;
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
                    ${dayData.map(d => {
                        let bg, border, textColor;
                        if (d.isFuture) {
                            bg = '#f8f9fa'; border = '#e0e0e0'; textColor = '#bdc3c7';
                        } else if (d.dayTrades.length === 0) {
                            bg = '#f8f9fa'; border = '#e0e0e0'; textColor = '#95a5a6';
                        } else if (d.pnl > 0) {
                            bg = '#f0fff4'; border = '#27ae60'; textColor = '#27ae60';
                        } else if (d.pnl < 0) {
                            bg = '#fff5f5'; border = '#e74c3c'; textColor = '#e74c3c';
                        } else {
                            bg = '#fffbf0'; border = '#f39c12'; textColor = '#f39c12';
                        }
                        const todayRing = d.isToday ? 'box-shadow: 0 0 0 2px #3498db;' : '';
                        return `
                            <div style="background:${bg}; border: 2px solid ${border}; border-radius: 10px; padding: 12px 8px; text-align: center; ${todayRing}">
                                <div style="font-size: 0.8em; color: #7f8c8d; font-weight: 600; margin-bottom: 4px;">
                                    ${d.label}${d.isToday ? ' <span style="color:#3498db;">‚óè</span>' : ''}
                                </div>
                                <div style="font-size: 0.75em; color: #aaa; margin-bottom: 6px;">
                                    ${d.date.getDate()}/${d.date.getMonth() + 1}
                                </div>
                                <div style="font-size: 1.1em; font-weight: 700; color: ${textColor};">
                                    ${d.isFuture ? '-' : d.dayTrades.length === 0 ? 'REST' : (d.pnl >= 0 ? '+' : '') + '$' + d.pnl.toFixed(0)}
                                </div>
                                ${!d.isFuture && d.dayTrades.length > 0 ? `<div style="font-size: 0.75em; color: #aaa; margin-top: 3px;">${d.dayTrades.length} trade${d.dayTrades.length !== 1 ? 's' : ''}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid ${weekPnl >= 0 ? '#27ae60' : '#e74c3c'};">
                    <span style="color: #7f8c8d; font-weight: 600;">Week Total</span>
                    <span style="font-size: 1.2em; font-weight: 700; color: ${weekPnl >= 0 ? '#27ae60' : '#e74c3c'};">
                        ${weekPnl >= 0 ? '+' : ''}$${weekPnl.toFixed(2)}
                    </span>
                    <span style="color: #aaa; font-size: 0.9em;">${tradedDays} day${tradedDays !== 1 ? 's' : ''} traded</span>
                </div>
            `;
            
            // Week stats - ONLY system trades for win/loss/R stats
            // But P&L above includes ALL trades (system + offsystem)
            const weekTrades = dayData.flatMap(d => d.dayTrades);
            const weekSystemTrades = weekTrades.filter(t => t.type === 'system');
            const weekWins = weekSystemTrades.filter(t => t.result === 'win').length;
            const weekLosses = weekSystemTrades.filter(t => t.result === 'loss').length;
            const weekBeWin = weekSystemTrades.filter(t => t.result === 'be_win').length;
            const weekBeLoss = weekSystemTrades.filter(t => t.result === 'be_loss').length;
            const weekWinRate = (weekWins + weekLosses) > 0 
                ? Math.round(weekWins / (weekWins + weekLosses) * 100) 
                : 0;
            const winRateColor = weekWinRate >= 60 ? '#27ae60' : weekWinRate >= 45 ? '#f39c12' : '#e74c3c';
            // Exclude BE trades from R calculation (only count wins and losses)
            const weekR = weekSystemTrades
                .filter(t => t.result === 'win' || t.result === 'loss')
                .reduce((sum, t) => sum + (t.rValue || 0), 0);
            const weekRColor = weekR > 0 ? '#27ae60' : weekR < 0 ? '#e74c3c' : '#f39c12';
            
            html += `
                <div style="margin-top: 15px;">
                    <div style="font-weight: 700; color: #2c3e50; margin-bottom: 10px; font-size: 1em;">Current Week Stats ‚Äî System Trades Only</div>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                        <div style="background: #f0fff4; border: 2px solid #27ae60; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: #27ae60;">${weekWins}</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">Wins</div>
                        </div>
                        <div style="background: #fff5f5; border: 2px solid #e74c3c; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: #e74c3c;">${weekLosses}</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">Losses</div>
                        </div>
                        <div style="background: #fffbf0; border: 2px solid #f39c12; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: #f39c12;">${weekBeWin}</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">BE/Win</div>
                        </div>
                        <div style="background: #fffbf0; border: 2px solid #f39c12; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: #f39c12;">${weekBeLoss}</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">BE/Loss</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f5f7fa, #c3cfe2); border: 2px solid #bdc3c7; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: ${winRateColor};">${weekWinRate}%</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">Win Rate</div>
                        </div>
                        <div style="background: ${weekR >= 0 ? '#f0fff4' : '#fff5f5'}; border: 2px solid ${weekRColor}; border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 1.6em; font-weight: 700; color: ${weekRColor};">${weekR >= 0 ? '+' : ''}${weekR.toFixed(2)}R</div>
                            <div style="font-size: 0.78em; color: #7f8c8d; font-weight: 600;">Total R</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function updateDisciplineStats() {
            const uniqueTrades = getUniqueTrades();
            const systemTrades = uniqueTrades.filter(t => t.type === 'system');
            const offsystemTrades = uniqueTrades.filter(t => t.type === 'offsystem');
            
            document.getElementById('totalTrades').textContent = uniqueTrades.length;
            document.getElementById('systemTrades').textContent = systemTrades.length;
            document.getElementById('offsystemTrades').textContent = offsystemTrades.length;
            
            const disciplineRate = uniqueTrades.length > 0 ? 
                Math.round((systemTrades.length / uniqueTrades.length) * 100) : 0;
            document.getElementById('disciplineRate').textContent = disciplineRate + '%';
            
            // System trade stats - BE trades excluded from win/loss calculation
            if (systemTrades.length > 0) {
                // Only count actual wins and losses, not BE trades
                const systemWinLossTrades = systemTrades.filter(t => 
                    !t.result || t.result === 'win' || t.result === 'loss'
                );
                const systemWinners = systemTrades.filter(t => 
                    (!t.result && t.pnl > 0) || t.result === 'win'
                );
                const systemLosers = systemTrades.filter(t => 
                    (!t.result && t.pnl < 0) || t.result === 'loss'
                );
                
                const systemWinRate = systemWinLossTrades.length > 0 ? 
                    Math.round((systemWinners.length / systemWinLossTrades.length) * 100) : 0;
                const systemPnl = systemTrades.reduce((sum, t) => sum + t.pnl, 0);
                const systemAvgWin = systemWinners.length > 0 ? 
                    systemWinners.reduce((sum, t) => sum + t.pnl, 0) / systemWinners.length : 0;
                const systemAvgLoss = systemLosers.length > 0 ? 
                    systemLosers.reduce((sum, t) => sum + t.pnl, 0) / systemLosers.length : 0;
                
                document.getElementById('systemWinRate').textContent = systemWinRate + '%';
                document.getElementById('systemPnl').textContent = '$' + systemPnl.toFixed(2);
                document.getElementById('systemPnl').className = 'stat-value ' + (systemPnl >= 0 ? 'positive' : 'negative');
                document.getElementById('systemAvgWin').textContent = '$' + systemAvgWin.toFixed(2);
                document.getElementById('systemAvgLoss').textContent = '$' + systemAvgLoss.toFixed(2);
            } else {
                document.getElementById('systemWinRate').textContent = '-';
                document.getElementById('systemPnl').textContent = '-';
                document.getElementById('systemAvgWin').textContent = '-';
                document.getElementById('systemAvgLoss').textContent = '-';
            }
            
            // Off-System trade stats - BE trades excluded from win/loss calculation
            if (offsystemTrades.length > 0) {
                // Only count actual wins and losses, not BE trades
                const offsystemWinLossTrades = offsystemTrades.filter(t => 
                    !t.result || t.result === 'win' || t.result === 'loss'
                );
                const offsystemWinners = offsystemTrades.filter(t => 
                    (!t.result && t.pnl > 0) || t.result === 'win'
                );
                const offsystemLosers = offsystemTrades.filter(t => 
                    (!t.result && t.pnl < 0) || t.result === 'loss'
                );
                
                const offsystemWinRate = offsystemWinLossTrades.length > 0 ? 
                    Math.round((offsystemWinners.length / offsystemWinLossTrades.length) * 100) : 0;
                const offsystemPnl = offsystemTrades.reduce((sum, t) => sum + t.pnl, 0);
                const offsystemAvgWin = offsystemWinners.length > 0 ? 
                    offsystemWinners.reduce((sum, t) => sum + t.pnl, 0) / offsystemWinners.length : 0;
                const offsystemAvgLoss = offsystemLosers.length > 0 ? 
                    offsystemLosers.reduce((sum, t) => sum + t.pnl, 0) / offsystemLosers.length : 0;
                
                document.getElementById('offsystemWinRate').textContent = offsystemWinRate + '%';
                document.getElementById('offsystemPnl').textContent = '$' + offsystemPnl.toFixed(2);
                document.getElementById('offsystemPnl').className = 'stat-value ' + (offsystemPnl >= 0 ? 'positive' : 'negative');
                document.getElementById('offsystemAvgWin').textContent = '$' + offsystemAvgWin.toFixed(2);
                document.getElementById('offsystemAvgLoss').textContent = '$' + offsystemAvgLoss.toFixed(2);
            } else {
                document.getElementById('offsystemWinRate').textContent = '-';
                document.getElementById('offsystemPnl').textContent = '-';
                document.getElementById('offsystemAvgWin').textContent = '-';
                document.getElementById('offsystemAvgLoss').textContent = '-';
            }
            
            // Off-System tax
        }
        
        function generateTradeHistoryFilters() {
            const container = document.getElementById('tradeHistoryFilters');
            if (!container) return;
            
            const accountButtons = Object.keys(ACCOUNTS).map(id => 
                `<div class="filter-btn" onclick="filterTrades('${id}', this)">${ACCOUNTS[id].name}</div>`
            ).join('');
            
            container.innerHTML = `
                <div class="filter-btn ${currentFilter === 'system' ? 'active' : ''}" onclick="filterTrades('system', this)">System Only</div>
                <div class="filter-btn ${currentFilter === 'offsystem' ? 'active' : ''}" onclick="filterTrades('offsystem', this)">Off-System Only</div>
                ${accountButtons}
                <div class="filter-btn ${currentFilter === 'all' ? 'active' : ''}" onclick="filterTrades('all', this)">All Accounts</div>
            `;
        }
        
        function displayTrades() {
            let displayTrades = trades.filter(t => t.type !== 'adjustment');
            
            if (currentFilter !== 'all') {
                if (currentFilter === 'system' || currentFilter === 'offsystem') {
                    displayTrades = displayTrades.filter(t => t.type === currentFilter);
                    
                    const uniqueTrades = [];
                    const seenBatches = new Set();
                    
                    displayTrades.forEach(trade => {
                        const batchKey = String(trade.batchId || Math.floor(trade.id / 10) * 10);
                        if (!seenBatches.has(batchKey)) {
                            seenBatches.add(batchKey);
                            uniqueTrades.push(trade);
                        }
                    });
                    
                    displayTrades = uniqueTrades;
                } else {
                    displayTrades = displayTrades.filter(t => t.account === currentFilter && t.type !== 'adjustment');
                }
            }
            
            displayTrades.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                const timeA = a.entryTime || a.time || '';
                const timeB = b.entryTime || b.time || '';
                return timeB.localeCompare(timeA);
            });
            
            const logDiv = document.getElementById('tradeLog');
            
            if (displayTrades.length === 0) {
                logDiv.innerHTML = '<div class="no-data">No trades to display</div>';
                return;
            }
            
            logDiv.innerHTML = displayTrades.map(trade => {
                const account = ACCOUNTS[trade.account];
                
                // If viewing System Only or Off-System Only, count accounts and sum PNL across batch
                let accountCount = 1;
                let displayPnl = trade.pnl;
                let displayR = trade.rValue !== undefined ? trade.rValue : null;
                let riskSizeLabel = trade.riskSize === 0.5 ? '¬ΩR' : '1R';
                if (currentFilter === 'system' || currentFilter === 'offsystem') {
                    const batchKey = String(trade.batchId || Math.floor(trade.id / 10) * 10);
                    const batchTrades = trades.filter(t => {
                        const tBatchKey = String(t.batchId || Math.floor(t.id / 10) * 10);
                        return tBatchKey === batchKey;
                    });
                    accountCount = batchTrades.length;
                    displayPnl = batchTrades.reduce((sum, t) => sum + t.pnl, 0);
                    // R value from first trade in batch (all same riskSize)
                    const firstWithR = batchTrades.find(t => t.rValue !== undefined);
                    displayR = firstWithR ? firstWithR.rValue : null;
                    riskSizeLabel = firstWithR && firstWithR.riskSize === 0.5 ? '¬ΩR' : '1R';
                }
                
                
                const resultClass = trade.result ? 
                    (trade.result === "win" ? "win" : 
                     trade.result === "loss" ? "loss" : "be") : 
                    (displayPnl >= 0 ? "win" : "loss");

                return `
                    <div class="trade-entry ${trade.type} ${resultClass}">
                        <div class="trade-header">
                            <div>
                                <span class="trade-type-badge ${trade.type}">
                                    ${trade.type === 'system' ? '‚úÖ System' : '‚ùå Off-System'}
                                </span>
                                ${trade.result ? `<span style="margin-left: 8px; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; background: ${
                                    trade.result === 'win' ? '#d4edda' : 
                                    trade.result === 'loss' ? '#f8d7da' : '#fff3cd'
                                }; color: ${
                                    trade.result === 'win' ? '#155724' : 
                                    trade.result === 'loss' ? '#721c24' : '#856404'
                                };">${
                                    trade.result === 'win' ? 'üü¢ WIN' : 
                                    trade.result === 'loss' ? 'üî¥ LOSS' : 
                                    trade.result === 'be_win' ? 'üü° BE/WIN' : 'üü° BE/LOSS'
                                }</span>` : ''}
                                ${accountCount > 1 ? `<span style="margin-left: 8px; padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600; background: #e3f2fd; color: #0d47a1;">üìä ${accountCount} accounts</span>` : `<span style="margin-left: 10px; font-weight: 600; color: #2c3e50;">${account.name}</span>`}
                            </div>
                            <div class="trade-pnl ${displayPnl >= 0 ? 'profit' : 'loss'}">
                                <div>${displayPnl >= 0 ? '+' : ''}$${displayPnl.toFixed(2)}</div>
                                ${displayR !== null && trade.result !== 'be_win' && trade.result !== 'be_loss' ? `<div style="font-size:0.78em; opacity:0.8; font-weight:600; margin-top:2px;">${displayR >= 0 ? '+' : ''}${displayR.toFixed(2)}R <span style="opacity:0.6;">(${riskSizeLabel})</span></div>` : ''}
                            </div>
                        </div>
                        <div class="trade-details">
                            <span>${formatDate(trade.date)}</span>
                            ${trade.entryTime && trade.exitTime ? `
                                <span>‚è±Ô∏è ${trade.entryTime} ‚Üí ${trade.exitTime} (${calculateDuration(trade.entryTime, trade.exitTime)})</span>
                            ` : trade.time ? `<span>${trade.time}</span>` : ''}
                            ${trade.symbol ? `<span style="padding: 2px 8px; border-radius: 4px; font-weight: 700; background: #e8f0fe; color: #1a56db; font-size:0.85em;">${trade.symbol}</span>` : ''}
                            ${trade.direction ? `<span>${trade.direction === 'long' ? 'üìà LONG' : 'üìâ SHORT'}</span>` : ''}
                            ${trade.model ? `<span>${MODELS[trade.model] ? MODELS[trade.model].name : trade.model}</span>` : ''}
                            ${trade.grade ? `<span style="padding: 2px 6px; border-radius: 4px; font-weight: 600; background: ${
                                trade.grade === 'A' ? '#d4edda' : 
                                trade.grade === 'B' ? '#d4edda' : 
                                trade.grade === 'C' ? '#fff3cd' : '#f8d7da'
                            }; color: ${
                                trade.grade === 'A' || trade.grade === 'B' ? '#155724' : 
                                trade.grade === 'C' ? '#856404' : '#721c24'
                            };">Grade ${trade.grade === 'troll' ? 'TROLL' : trade.grade}</span>` : ''}
                        </div>
                        ${trade.note ? `<div style="margin-top: 8px; color: #666; font-size: 0.95em;">${trade.note}</div>` : ''}
                        ${trade.screenshot ? `
                            <button class="btn" onclick="openModal('${trade.screenshot}'); return false;" style="width: auto; padding: 8px 16px; margin-top: 10px; font-size: 0.9em;">
                                üì∏ View Screenshot
                            </button>
                        ` : ''}
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button class="btn" onclick="editTrade(${trade.id}, '${currentFilter}'); return false;" style="width: auto; padding: 8px 16px; font-size: 0.9em; background: #3498db;">‚úèÔ∏è Edit</button>
                            <button class="delete-btn" onclick="deleteTrade(${trade.id}); return false;">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Payouts and Costs data
        let payouts = JSON.parse(localStorage.getItem('propPayouts')) || [];
        let costs = JSON.parse(localStorage.getItem('propCosts')) || [];
        
        function updatePayoutPreview() {
            const grossAmount = parseFloat(document.getElementById('payout-amount').value) || 0;
            const splitPercent = parseInt(document.getElementById('payout-split').value) || 100;
            const netAmount = grossAmount * (splitPercent / 100);
            
            document.getElementById('payout-net').value = netAmount.toFixed(2);
        }
        
        // Helper function to save trades to localStorage without screenshots
        function saveTradesToLocalStorage() {
            const tradesWithoutScreenshots = trades.map(t => {
                if (t.screenshot) {
                    const { screenshot, ...tradeWithoutScreenshot } = t;
                    return tradeWithoutScreenshot;
                }
                return t;
            });
            localStorage.setItem('propTrades', JSON.stringify(tradesWithoutScreenshots));
        }
        
        function addPayout() {
            const accountId = document.getElementById('payout-account').value;
            const grossAmount = parseFloat(document.getElementById('payout-amount').value);
            const splitPercent = parseInt(document.getElementById('payout-split').value);
            const netAmount = grossAmount * (splitPercent / 100);
            const date = document.getElementById('payout-date').value;
            const note = document.getElementById('payout-note').value || 'Payout';
            
            if (!accountId || isNaN(grossAmount) || grossAmount <= 0 || !date) {
                alert('Please fill in all required fields');
                return;
            }
            
            const payout = {
                id: Date.now(),
                accountId: accountId,
                accountName: ACCOUNTS[accountId].name,
                grossAmount: grossAmount,
                netAmount: netAmount,
                splitPercent: splitPercent,
                date: date,
                note: note,
                timestamp: new Date().toISOString()
            };
            
            payouts.push(payout);
            localStorage.setItem('propPayouts', JSON.stringify(payouts));
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            // Clear inputs
            document.getElementById('payout-amount').value = '';
            document.getElementById('payout-net').value = '';
            document.getElementById('payout-note').value = '';
            
            renderPayoutsTab();
            updateDisplay();
            
            // Update adjustment balance if Settings tab exists
            setTimeout(() => {
                if (document.getElementById('adj-amount')) {
                    updateAdjustmentBalance();
                }
            }, 100);
            
            alert(`‚úÖ Payout recorded for ${ACCOUNTS[accountId].name}\n\nGross (withdrawn): $${grossAmount.toFixed(2)}\nSplit: ${splitPercent}%\nNet (received): $${netAmount.toFixed(2)}`);
        }
        
        function deletePayout(id) {
            if (!confirm('Delete this payout record?')) return;
            const payoutId = Number(id);
            payouts = payouts.filter(p => Number(p.id) !== payoutId);
            localStorage.setItem('propPayouts', JSON.stringify(payouts));
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            renderPayoutsTab();
            updateDisplay();
            
            // Update adjustment balance if on settings tab
            if (document.getElementById('settings').classList.contains('active')) {
                updateAdjustmentBalance();
            }
        }
        
        function addCost() {
            const type = document.getElementById('cost-type').value;
            const size = parseFloat(document.getElementById('cost-size').value);
            const price = parseFloat(document.getElementById('cost-price').value);
            const company = document.getElementById('cost-company').value;
            const date = document.getElementById('cost-date').value;
            const status = document.getElementById('cost-status').value;
            
            if (isNaN(size) || isNaN(price) || !company || !date) {
                alert('Please fill in all required fields');
                return;
            }
            
            const cost = {
                id: Date.now(),
                type: type,
                size: size,
                price: price,
                company: company,
                date: date,
                status: status,
                timestamp: new Date().toISOString()
            };
            
            costs.push(cost);
            localStorage.setItem('propCosts', JSON.stringify(costs));
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            // Clear inputs
            document.getElementById('cost-size').value = '';
            document.getElementById('cost-price').value = '';
            document.getElementById('cost-company').value = '';
            
            renderPayoutsTab();
            alert(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} cost of $${price.toFixed(2)} recorded`);
        }
        
        function deleteCost(id) {
            if (!confirm('Delete this cost record?')) return;
            const costId = Number(id);
            costs = costs.filter(c => Number(c.id) !== costId);
            localStorage.setItem('propCosts', JSON.stringify(costs));
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            renderPayoutsTab();
        }
        
        function updateCostStatus(id, newStatus) {
            const costId = Number(id);
            const cost = costs.find(c => Number(c.id) === costId);
            if (cost) {
                cost.status = newStatus;
                localStorage.setItem('propCosts', JSON.stringify(costs));
                
                if (useDriveSync) {
                    clearTimeout(window.syncTimeout);
                    window.syncTimeout = setTimeout(syncToDrive, 2000);
                }
                
                renderPayoutsTab();
            }
        }
        
        function renderPayoutsTab() {
            // Update summary
            const totalPayoutsGross = payouts.reduce((sum, p) => sum + (p.grossAmount || p.amount || 0), 0);
            const totalPayoutsNet = payouts.reduce((sum, p) => sum + (p.netAmount || p.amount || 0), 0);
            const totalCosts = costs.reduce((sum, c) => sum + c.price, 0);
            const netProfit = totalPayoutsNet - totalCosts;
            
            document.getElementById('totalPayoutsGross').textContent = '$' + totalPayoutsGross.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalPayoutsNet').textContent = '$' + totalPayoutsNet.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalCosts').textContent = '$' + totalCosts.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('netPayouts').textContent = (netProfit >= 0 ? '+' : '') + '$' + netProfit.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('netPayouts').style.color = netProfit >= 0 ? '#27ae60' : '#e74c3c';
            
            // Populate account dropdown
            const payoutAccountSelect = document.getElementById('payout-account');
            if (payoutAccountSelect) {
                payoutAccountSelect.innerHTML = Object.keys(ACCOUNTS).map(id => 
                    `<option value="${id}">${ACCOUNTS[id].name}</option>`
                ).join('');
            }
            
            // Render payout history
            const payoutHistory = document.getElementById('payoutHistory');
            if (payoutHistory) {
                if (payouts.length === 0) {
                    payoutHistory.innerHTML = '<div class="no-data">No payouts yet</div>';
                } else {
                    const sortedPayouts = [...payouts].sort((a, b) => b.id - a.id);
                    payoutHistory.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Date</th>
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Account</th>
                                    <th style="text-align: right; padding: 10px; font-weight: 600;">Gross</th>
                                    <th style="text-align: center; padding: 10px; font-weight: 600;">Split</th>
                                    <th style="text-align: right; padding: 10px; font-weight: 600;">Net</th>
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Note</th>
                                    <th style="text-align: center; padding: 10px; font-weight: 600;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedPayouts.map(p => {
                                    const gross = p.grossAmount || p.amount || 0;
                                    const net = p.netAmount || p.amount || 0;
                                    const split = p.splitPercent || 100;
                                    return `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 10px;">${p.date}</td>
                                        <td style="padding: 10px;">${p.accountName}</td>
                                        <td style="padding: 10px; text-align: right; color: #27ae60; font-weight: 600;">$${gross.toFixed(2)}</td>
                                        <td style="padding: 10px; text-align: center; font-weight: 600; color: #7f8c8d;">${split}%</td>
                                        <td style="padding: 10px; text-align: right; color: #27ae60; font-weight: 600;">$${net.toFixed(2)}</td>
                                        <td style="padding: 10px;">${p.note}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="deletePayout(${p.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `;
                }
            }
            
            // Render cost history
            const costHistory = document.getElementById('costHistory');
            if (costHistory) {
                if (costs.length === 0) {
                    costHistory.innerHTML = '<div class="no-data">No costs yet</div>';
                } else {
                    const sortedCosts = [...costs].sort((a, b) => b.id - a.id);
                    costHistory.innerHTML = `
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 2px solid #e0e0e0;">
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Date</th>
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Type</th>
                                    <th style="text-align: left; padding: 10px; font-weight: 600;">Company</th>
                                    <th style="text-align: right; padding: 10px; font-weight: 600;">Size</th>
                                    <th style="text-align: right; padding: 10px; font-weight: 600;">Cost</th>
                                    <th style="text-align: center; padding: 10px; font-weight: 600;">Status</th>
                                    <th style="text-align: center; padding: 10px; font-weight: 600;">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedCosts.map(c => {
                                    const typeLabels = { challenge: 'Challenge', s2f: 'S2F', reset: 'Reset' };
                                    const statusColors = { pending: '#f39c12', passed: '#27ae60', failed: '#e74c3c' };
                                    return `
                                    <tr style="border-bottom: 1px solid #f0f0f0;">
                                        <td style="padding: 10px;">${c.date}</td>
                                        <td style="padding: 10px;">${typeLabels[c.type]}</td>
                                        <td style="padding: 10px;">${c.company}</td>
                                        <td style="padding: 10px; text-align: right;">$${c.size.toLocaleString()}</td>
                                        <td style="padding: 10px; text-align: right; color: #e74c3c; font-weight: 600;">-$${c.price.toFixed(2)}</td>
                                        <td style="padding: 10px; text-align: center;">
                                            <select onchange="updateCostStatus(${c.id}, this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid ${statusColors[c.status]}; color: ${statusColors[c.status]}; font-weight: 600;">
                                                <option value="pending" ${c.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="passed" ${c.status === 'passed' ? 'selected' : ''}>Passed ‚úÖ</option>
                                                <option value="failed" ${c.status === 'failed' ? 'selected' : ''}>Failed ‚ùå</option>
                                            </select>
                                        </td>
                                        <td style="padding: 10px; text-align: center;">
                                            <button onclick="deleteCost(${c.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Delete</button>
                                        </td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    `;
                }
            }
        }
        
        // Trade History rendering
        function renderTradeHistory() {
            const timeFilter = document.getElementById('history-time-filter').value;
            const accountFilter = document.getElementById('history-account-filter').value;
            const typeFilter = document.getElementById('history-type-filter').value;
            const resultFilter = document.getElementById('history-result-filter').value;
            
            // Populate account filter dropdown
            const accountSelect = document.getElementById('history-account-filter');
            if (accountSelect.options.length === 1) { // Only has "All Accounts"
                Object.keys(ACCOUNTS).forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = ACCOUNTS[id].name;
                    accountSelect.appendChild(option);
                });
            }
            
            // Filter trades by time range
            const now = new Date();
            let filteredTrades = trades.filter(t => t.type !== 'adjustment');
            
            if (timeFilter !== 'all') {
                filteredTrades = filteredTrades.filter(t => {
                    if (!t.date) return false;
                    const tradeDate = new Date(t.date);
                    
                    if (timeFilter === 'today') {
                        return t.date === now.toISOString().split('T')[0];
                    } else if (timeFilter === 'week') {
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay() + 1); // Monday
                        weekStart.setHours(0,0,0,0);
                        return tradeDate >= weekStart;
                    } else if (timeFilter === 'month') {
                        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                        return tradeDate >= monthStart;
                    } else if (timeFilter === 'last-week') {
                        const lastWeekStart = new Date(now);
                        lastWeekStart.setDate(now.getDate() - now.getDay() - 6); // Last Monday
                        lastWeekStart.setHours(0,0,0,0);
                        const lastWeekEnd = new Date(lastWeekStart);
                        lastWeekEnd.setDate(lastWeekStart.getDate() + 6);
                        lastWeekEnd.setHours(23,59,59,999);
                        return tradeDate >= lastWeekStart && tradeDate <= lastWeekEnd;
                    } else if (timeFilter === 'last-month') {
                        const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
                        return tradeDate >= lastMonthStart && tradeDate <= lastMonthEnd;
                    }
                    return true;
                });
            }
            
            // Filter by account
            if (accountFilter !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.account === accountFilter);
            }
            
            // Filter by type
            if (typeFilter !== 'all') {
                filteredTrades = filteredTrades.filter(t => t.type === typeFilter);
            }
            
            // Filter by result
            if (resultFilter !== 'all') {
                if (resultFilter === 'be') {
                    filteredTrades = filteredTrades.filter(t => t.result && t.result.startsWith('be'));
                } else {
                    filteredTrades = filteredTrades.filter(t => t.result === resultFilter);
                }
            }
            
            // Group by date
            const tradesByDate = {};
            filteredTrades.forEach(trade => {
                if (!trade.date) return;
                if (!tradesByDate[trade.date]) {
                    tradesByDate[trade.date] = [];
                }
                tradesByDate[trade.date].push(trade);
            });
            
            // Sort dates descending (newest first)
            const sortedDates = Object.keys(tradesByDate).sort((a, b) => b.localeCompare(a));
            
            const content = document.getElementById('trade-history-content');
            
            if (sortedDates.length === 0) {
                content.innerHTML = '<div class="card"><div class="no-data">No trades found for selected filters</div></div>';
                return;
            }
            
            // Render trades grouped by date
            content.innerHTML = sortedDates.map(date => {
                const dayTrades = tradesByDate[date];
                const dayPnl = dayTrades.reduce((sum, t) => sum + t.pnl, 0);
                const dayR = dayTrades.reduce((sum, t) => sum + (t.rValue || 0), 0);
                const dateObj = new Date(date + 'T00:00:00');
                const dateLabel = dateObj.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                
                return `
                    <div class="card" style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                            <h2 style="margin: 0; color: #2c3e50;">üìÖ ${dateLabel}</h2>
                            <div style="display: flex; gap: 20px;">
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85em; color: #7f8c8d;">P&L</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${dayPnl >= 0 ? '#27ae60' : '#e74c3c'};">
                                        ${dayPnl >= 0 ? '+' : ''}$${dayPnl.toFixed(2)}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85em; color: #7f8c8d;">Total R</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: ${dayR >= 0 ? '#27ae60' : '#e74c3c'};">
                                        ${dayR >= 0 ? '+' : ''}${dayR.toFixed(2)}R
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.85em; color: #7f8c8d;">Trades</div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #3498db;">
                                        ${dayTrades.length}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${dayTrades.map(trade => renderTradeCard(trade)).join('')}
                    </div>
                `;
            }).join('');
        }
        
        function renderTradeCard(trade) {
            const account = ACCOUNTS[trade.account];
            if (!account) {
                console.warn('Trade references deleted account:', trade.account);
                return ''; // Skip trades with deleted accounts
            }
            
            const resultColors = {
                win: '#27ae60',
                loss: '#e74c3c',
                'be-win': '#f39c12',
                'be-loss': '#f39c12',
                'be_win': '#f39c12',
                'be_loss': '#f39c12'
            };
            const resultLabels = {
                win: 'üü¢ WIN',
                loss: 'üî¥ LOSS',
                'be-win': 'üü° BE/WIN',
                'be-loss': 'üü° BE/LOSS',
                'be_win': 'üü° BE/WIN',
                'be_loss': 'üü° BE/LOSS'
            };
            const typeLabels = {
                system: '‚úÖ System',
                offsystem: '‚ùå Off-System'
            };
            
            return `
                <div style="border: 2px solid #e0e0e0; border-radius: 10px; padding: 20px; margin-bottom: 15px; background: #f8f9fa;">
                    <div style="display: grid; grid-template-columns: ${trade.screenshot ? '300px 1fr' : '1fr'}; gap: 20px;">
                        ${trade.screenshot ? `
                            <div>
                                <img src="${trade.screenshot}" 
                                     onclick="openImageModal('${trade.screenshot}')" 
                                     style="width: 100%; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                     alt="Trade screenshot">
                            </div>
                        ` : ''}
                        
                        <div>
                            <!-- Trade Header -->
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                <div>
                                    <div style="font-size: 1.1em; font-weight: 700; color: #2c3e50; margin-bottom: 5px;">
                                        ${trade.symbol} ${trade.direction === 'long' ? 'üìà' : 'üìâ'} ${trade.direction.toUpperCase()}
                                    </div>
                                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                        <span style="background: ${resultColors[trade.result]}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                            ${resultLabels[trade.result]}
                                        </span>
                                        <span style="background: ${trade.type === 'system' ? '#3498db' : '#95a5a6'}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                            ${typeLabels[trade.type]}
                                        </span>
                                        <span style="background: #ecf0f1; color: #2c3e50; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                                            ${account.name}
                                        </span>
                                    </div>
                                </div>
                                
                                <div style="text-align: right;">
                                    <div style="font-size: 1.5em; font-weight: bold; color: ${trade.pnl >= 0 ? '#27ae60' : '#e74c3c'};">
                                        ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                                    </div>
                                    ${trade.rValue ? `
                                        <div style="font-size: 1.1em; font-weight: 600; color: ${trade.rValue >= 0 ? '#27ae60' : '#e74c3c'};">
                                            ${trade.rValue >= 0 ? '+' : ''}${trade.rValue.toFixed(2)}R
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Trade Details Grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                ${trade.entryTime ? `
                                    <div>
                                        <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Entry</div>
                                        <div style="font-weight: 600; color: #2c3e50;">${trade.entryTime}</div>
                                    </div>
                                ` : ''}
                                ${trade.exitTime ? `
                                    <div>
                                        <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Exit</div>
                                        <div style="font-weight: 600; color: #2c3e50;">${trade.exitTime}</div>
                                    </div>
                                ` : ''}
                                ${trade.duration ? `
                                    <div>
                                        <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Duration</div>
                                        <div style="font-weight: 600; color: #2c3e50;">${trade.duration}</div>
                                    </div>
                                ` : ''}
                                <div>
                                    <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Risk</div>
                                    <div style="font-weight: 600; color: #2c3e50;">${trade.risk ? '$' + trade.risk.toFixed(2) : 'N/A'}</div>
                                </div>
                                ${trade.model ? `
                                    <div>
                                        <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px;">Model</div>
                                        <div style="font-weight: 600; color: #2c3e50;">${MODELS[trade.model] ? MODELS[trade.model].name : 'N/A'}</div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- Notes Section -->
                            <div style="background: white; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
                                <div style="font-size: 0.75em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Notes</div>
                                <textarea 
                                    id="trade-note-${trade.id}" 
                                    onblur="updateTradeNote(${trade.id})"
                                    style="width: 100%; min-height: 60px; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px; font-size: 0.95em; font-family: inherit; resize: vertical;"
                                    placeholder="Add your trade notes here...">${trade.note || ''}</textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 10px;">
                                <button onclick="editTradeFromHistory(${trade.id})" style="flex: 1; padding: 8px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    ‚úèÔ∏è Edit Trade
                                </button>
                                <button onclick="deleteTrade(${trade.id})" style="flex: 1; padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateTradeNote(tradeId) {
            const noteEl = document.getElementById(`trade-note-${tradeId}`);
            if (!noteEl) return;
            
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;
            
            trade.note = noteEl.value;
            saveTradesToLocalStorage();
            
            if (useDriveSync) {
                clearTimeout(window.syncTimeout);
                window.syncTimeout = setTimeout(syncToDrive, 2000);
            }
            
            console.log('Updated trade note for trade', tradeId);
        }
        
        function editTradeFromHistory(tradeId) {
            // Find the trade and open edit modal (existing functionality)
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;
            
            // Switch to trade-history tab if not already there, then open modal
            // For now, just alert - you can connect this to your existing edit modal
            alert('Edit functionality: This will open the existing edit modal. Connect to openEditModal() function.');
        }
        
        function openImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-image');
            img.src = imageSrc;
            modal.style.display = 'flex';
        }
        
        function closeImageModal() {
            const modal = document.getElementById('image-modal');
            modal.style.display = 'none';
        }
        
        // Initialize
        generateAccountOptions();
        generateModelOptions();
        generateSymbolOptions();
        
        // Select all accounts by default - needs to run after DOM is ready
        setTimeout(() => {
            applyToAll();
        }, 0);
        
        document.getElementById('adj-date').valueAsDate = new Date();
        document.getElementById('payout-date').valueAsDate = new Date();
        document.getElementById('cost-date').valueAsDate = new Date();
        renderSettingsPage();
        renderPayoutsTab();
        
        // Initialize trade history with error handling
        try {
            renderTradeHistory();
        } catch (error) {
            console.error('Error rendering trade history:', error);
            // Don't let trade history errors break the whole app
        }
        
        updateDisplay();
    </script>
    <!-- Drive Sync Status Widget - Fixed Bottom Left -->
    <div id="drive-status-widget" style="position: fixed; bottom: 20px; left: 20px; width: 210px; background: rgba(255,255,255,0.98); padding: 14px 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; border: 2px solid #4285f4;">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
            <span style="font-size: 20px;">‚òÅÔ∏è</span>
            <span style="font-weight: 700; font-size: 1em; color: #2c3e50;">Drive Sync</span>
        </div>
        <div id="drive-status-overview" style="font-size: 0.9em; color: #7f8c8d; font-weight: 500;">Checking...</div>
        <div id="drive-last-sync-overview" style="font-size: 0.8em; color: #95a5a6; margin-top: 4px;"></div>
    </div>
    
    <!-- Image Modal for Screenshots -->
    <div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;" onclick="closeImageModal()">
        <div style="position: relative; max-width: 90%; max-height: 90%; display: flex; align-items: center; justify-content: center;">
            <img id="modal-image" src="" style="max-width: 100%; max-height: 90vh; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);">
            <button onclick="closeImageModal()" style="position: absolute; top: 20px; right: 20px; background: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">‚úï</button>
        </div>
    </div>
    
</body>
</html>
